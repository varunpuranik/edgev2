<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1607px" preserveAspectRatio="none" style="width:1721px;height:1607px;" version="1.1" viewBox="0 0 1721 1607" width="1721px" zoomAndPan="magnify"><defs><filter height="300%" id="f9uebaeipgcwz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1592.6172" style="stroke: #A80036; stroke-width: 1.0;" width="927.5" x="776.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="1215.75" y="16.0669">Device</text><rect fill="#FFFFFF" filter="url(#f9uebaeipgcwz)" height="231.1953" style="stroke: #000000; stroke-width: 2.0;" width="572" x="13" y="91.7266"/><rect fill="#FFFFFF" filter="url(#f9uebaeipgcwz)" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="855.5" x="13" y="336.9219"/><rect fill="#FFFFFF" filter="url(#f9uebaeipgcwz)" height="1054.4375" style="stroke: #000000; stroke-width: 2.0;" width="1697" x="13" y="470.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="63" x2="63" y1="74.7266" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="358.5" x2="358.5" y1="74.7266" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="448.5" x2="448.5" y1="74.7266" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="552" x2="552" y1="74.7266" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="819.5" x2="819.5" y1="74.7266" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1136.5" x2="1136.5" y1="753.5625" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1329.5" x2="1329.5" y1="929.5234" y2="1542.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1663" x2="1663" y1="982.9688" y2="1542.0234"/><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="23" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="30" y="59.4248">Operator</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="23" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="30" y="1561.0186">Operator</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="323.5" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="330.5" y="59.4248">IoT Hub</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="323.5" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="330.5" y="1561.0186">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="403.5" y="71.4248">Edge device</text><ellipse cx="449" cy="42.4297" fill="#FEFECE" filter="url(#f9uebaeipgcwz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="437" x2="461" y1="56.4297" y2="56.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="403.5" y="1554.0186">Edge device</text><ellipse cx="449" cy="1573.3203" fill="#FEFECE" filter="url(#f9uebaeipgcwz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="437" x2="461" y1="1587.3203" y2="1587.3203"/><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="530" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="537" y="59.4248">DPS</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="530" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="537" y="1561.0186">DPS</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="780.5" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="787.5" y="43.1279">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="791" y="59.4248">runtime</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="780.5" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="787.5" y="1561.0186">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="791" y="1577.3154">runtime</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1088.5" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1095.5" y="1561.0186">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1289.5" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1296.5" y="1561.0186">EdgeHub</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1627" y="1541.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1634" y="1561.0186">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1637" y="1577.3154">Module</text><path d="M13,91.7266 L149,91.7266 L149,98.7266 L139,108.7266 L13,108.7266 L13,91.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="231.1953" style="stroke: #000000; stroke-width: 2.0;" width="572" x="13" y="91.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="28" y="104.7935">Initial Setup</text><polygon fill="#A80036" points="540.5,141.125,550.5,145.125,540.5,149.125,544.5,145.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="546.5" y1="145.125" y2="145.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="132.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="83.5" y="124.9263">Register signing CA Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="83.5" y="140.0591">for signing certificates</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="105.5" y1="189.3906" y2="189.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105.5" x2="105.5" y1="189.3906" y2="202.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64.5" x2="105.5" y1="202.3906" y2="202.3906"/><polygon fill="#A80036" points="74.5,198.3906,64.5,202.3906,74.5,206.3906,70.5,202.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="176.7583">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="83.5" y="169.1919">Generate bootstrap cert (DBC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="83.5" y="184.3247">Identity CA Cert (CA2).</text><path d="M28,215.3906 L28,255.3906 L393,255.3906 L393,225.3906 L383,215.3906 L28,215.3906 " fill="#FBFB77" filter="url(#f9uebaeipgcwz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M383,215.3906 L383,225.3906 L393,225.3906 L383,215.3906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="41.25" y="232.4575">CA1 and CA2 can be same or different in this case</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="41.25" y="247.5903">because device does not have the CA cert</text><polygon fill="#A80036" points="540.5,281.7891,550.5,285.7891,540.5,289.7891,544.5,285.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="546.5" y1="285.7891" y2="285.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="70.5" y="280.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="82.5" y="280.7231">Create group enrollment with Idenity CA Certificate (CA2)</text><polygon fill="#A80036" points="437,310.9219,447,314.9219,437,318.9219,441,314.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="443" y1="314.9219" y2="314.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="309.856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="83.5" y="309.856">Install DBC on the device (file system or HSM)</text><path d="M13,336.9219 L295,336.9219 L295,343.9219 L285,353.9219 L13,353.9219 L13,336.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="855.5" x="13" y="336.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="28" y="349.9888">Device setup and configuration</text><polygon fill="#A80036" points="807.5,371.1875,817.5,375.1875,807.5,379.1875,811.5,375.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="813.5" y1="375.1875" y2="375.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="370.1216">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="83.5" y="370.1216">Configure device to sign certificates using DPS as a CA</text><polygon fill="#A80036" points="807.5,400.3203,817.5,404.3203,807.5,408.3203,811.5,404.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="813.5" y1="404.3203" y2="404.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="399.2544">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="83.5" y="399.2544">Configure device for DPS provisioning</text><polygon fill="#A80036" points="807.5,444.5859,817.5,448.5859,807.5,452.5859,811.5,448.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="813.5" y1="448.5859" y2="448.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="435.9536">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="611" x="83.5" y="428.3872">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="83.5" y="443.52">Configure EH Bridge to send telemetry upstream.</text><path d="M13,470.5859 L168,470.5859 L168,477.5859 L158,487.5859 L13,487.5859 L13,470.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1054.4375" style="stroke: #000000; stroke-width: 2.0;" width="1697" x="13" y="470.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="28" y="483.6528">Device running</text><polygon fill="#A80036" points="807.5,504.8516,817.5,508.8516,807.5,512.8516,811.5,508.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="813.5" y1="508.8516" y2="508.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="503.7856">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="83.5" y="503.7856">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="861.5" y1="537.9844" y2="537.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="861.5" x2="861.5" y1="537.9844" y2="550.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="820.5" x2="861.5" y1="550.9844" y2="550.9844"/><polygon fill="#A80036" points="830.5,546.9844,820.5,550.9844,830.5,554.9844,826.5,550.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="826.5" y="532.9185">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="839.5" y="532.9185">Generate CSR for device identity cert (DIdC)</text><polygon fill="#A80036" points="563.5,591.25,553.5,595.25,563.5,599.25,559.5,595.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="557.5" x2="818.5" y1="595.25" y2="595.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="569.5" y="582.6177">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="592.5" y="575.0513">Provision device with DBC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="592.5" y="590.1841">+CSR for DIdC</text><polygon fill="#A80036" points="369.5,635.5156,359.5,639.5156,369.5,643.5156,365.5,639.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="363.5" x2="551.5" y1="639.5156" y2="639.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="375.5" y="626.8833">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="397.5" y="619.3169">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="397.5" y="634.4497">thumbprint based auth</text><polygon fill="#A80036" points="540.5,664.6484,550.5,668.6484,540.5,672.6484,544.5,668.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="358.5" x2="546.5" y1="668.6484" y2="668.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="365.5" y="663.5825">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="387.5" y="663.5825">Device info</text><polygon fill="#A80036" points="807.5,708.9141,817.5,712.9141,807.5,716.9141,811.5,712.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="552.5" x2="813.5" y1="712.9141" y2="712.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="559.5" y="700.2817">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="580.5" y="692.7153">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="580.5" y="707.8481">(IoTHub + deviceId + signed DIdC)</text><polygon fill="#A80036" points="1076.5,738.0469,1086.5,742.0469,1076.5,746.0469,1080.5,742.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="1082.5" y1="742.0469" y2="742.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="826.5" y="736.981">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="848.5" y="736.981">Create and start</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1088.5" y="720.9141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1095.5" y="740.9092">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1136.5" x2="1178.5" y1="787.3438" y2="787.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1178.5" x2="1178.5" y1="787.3438" y2="800.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1137.5" x2="1178.5" y1="800.3438" y2="800.3438"/><polygon fill="#A80036" points="1147.5,796.3438,1137.5,800.3438,1147.5,804.3438,1143.5,800.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1143.5" y="782.2778">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1165.5" y="782.2778">Process deployment</text><polygon fill="#A80036" points="830.5,840.6094,820.5,844.6094,830.5,848.6094,826.5,844.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="1135.5" y1="844.6094" y2="844.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="836.5" y="831.9771">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="858.5" y="824.4106">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="858.5" y="839.5435">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="369.5,884.875,359.5,888.875,369.5,892.875,365.5,888.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="363.5" x2="818.5" y1="888.875" y2="888.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="375.5" y="876.2427">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="397.5" y="868.6763">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="397.5" y="883.8091">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1277.5,914.0078,1287.5,918.0078,1277.5,922.0078,1281.5,918.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1136.5" x2="1283.5" y1="918.0078" y2="918.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1143.5" y="912.9419">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1165.5" y="912.9419">Create and start</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1289.5" y="896.875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1296.5" y="916.8701">EdgeHub</text><polygon fill="#A80036" points="1615,959.3047,1625,963.3047,1615,967.3047,1619,963.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1136.5" x2="1621" y1="963.3047" y2="963.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1143.5" y="958.2388">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1165.5" y="958.2388">Create and start</text><rect fill="#FEFECE" filter="url(#f9uebaeipgcwz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1627" y="942.1719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1634" y="962.167">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1637" y="978.4639">Module</text><polygon fill="#A80036" points="830.5,1020.8984,820.5,1024.8984,830.5,1028.8984,826.5,1024.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="1328.5" y1="1024.8984" y2="1024.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="836.5" y="1019.8325">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="859.5" y="1019.8325">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="861.5" y1="1054.0313" y2="1054.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="861.5" x2="861.5" y1="1054.0313" y2="1067.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="820.5" x2="861.5" y1="1067.0313" y2="1067.0313"/><polygon fill="#A80036" points="830.5,1063.0313,820.5,1067.0313,830.5,1071.0313,826.5,1067.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="826.5" y="1048.9653">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="848.5" y="1048.9653">Generate CSR for server cert</text><polygon fill="#A80036" points="563.5,1092.1641,553.5,1096.1641,563.5,1100.1641,559.5,1096.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="557.5" x2="818.5" y1="1096.1641" y2="1096.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="569.5" y="1091.0981">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="591.5" y="1091.0981">CSR for server cert</text><polygon fill="#A80036" points="807.5,1121.2969,817.5,1125.2969,807.5,1129.2969,811.5,1125.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="552.5" x2="813.5" y1="1125.2969" y2="1125.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="559.5" y="1120.231">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="580.5" y="1120.231">Cert signed with CA1</text><polygon fill="#A80036" points="1317.5,1150.4297,1327.5,1154.4297,1317.5,1158.4297,1321.5,1154.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819.5" x2="1323.5" y1="1154.4297" y2="1154.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="826.5" y="1149.3638">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="848.5" y="1149.3638">Server cert</text><polygon fill="#A80036" points="830.5,1179.5625,820.5,1183.5625,830.5,1187.5625,826.5,1183.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="1662.5" y1="1183.5625" y2="1183.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="836.5" y="1178.4966">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="858.5" y="1178.4966">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="861.5" y1="1212.6953" y2="1212.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="861.5" x2="861.5" y1="1212.6953" y2="1225.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="820.5" x2="861.5" y1="1225.6953" y2="1225.6953"/><polygon fill="#A80036" points="830.5,1221.6953,820.5,1225.6953,830.5,1229.6953,826.5,1225.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="826.5" y="1207.6294">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="848.5" y="1207.6294">Generate CSR for client cert</text><polygon fill="#A80036" points="563.5,1250.8281,553.5,1254.8281,563.5,1258.8281,559.5,1254.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="557.5" x2="818.5" y1="1254.8281" y2="1254.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="569.5" y="1249.7622">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="591.5" y="1249.7622">CSR for client cert</text><polygon fill="#A80036" points="807.5,1279.9609,817.5,1283.9609,807.5,1287.9609,811.5,1283.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="552.5" x2="813.5" y1="1283.9609" y2="1283.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="559.5" y="1278.895">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="581.5" y="1278.895">Cert signed with CA1</text><polygon fill="#A80036" points="1651.5,1309.0938,1661.5,1313.0938,1651.5,1317.0938,1655.5,1313.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819.5" x2="1657.5" y1="1313.0938" y2="1313.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="826.5" y="1308.0278">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="848.5" y="1308.0278">Module local identity</text><polygon fill="#A80036" points="1340.5,1338.2266,1330.5,1342.2266,1340.5,1346.2266,1336.5,1342.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1334.5" x2="1662.5" y1="1342.2266" y2="1342.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1346.5" y="1337.1606">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1368.5" y="1337.1606">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1340.5,1367.3594,1330.5,1371.3594,1340.5,1375.3594,1336.5,1371.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1334.5" x2="1662.5" y1="1371.3594" y2="1371.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1346.5" y="1366.2935">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1367.5" y="1366.2935">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="830.5,1396.4922,820.5,1400.4922,830.5,1404.4922,826.5,1400.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="1328.5" y1="1400.4922" y2="1400.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="836.5" y="1395.4263">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="857.5" y="1395.4263">Get IoTHub identity</text><polygon fill="#A80036" points="1317.5,1425.625,1327.5,1429.625,1317.5,1433.625,1321.5,1429.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819.5" x2="1323.5" y1="1429.625" y2="1429.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="826.5" y="1424.5591">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="846.5" y="1424.5591">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="830.5,1454.7578,820.5,1458.7578,830.5,1462.7578,826.5,1458.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="1328.5" y1="1458.7578" y2="1458.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="836.5" y="1453.6919">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="857.5" y="1453.6919">Sign token</text><polygon fill="#A80036" points="1317.5,1483.8906,1327.5,1487.8906,1317.5,1491.8906,1321.5,1487.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819.5" x2="1323.5" y1="1487.8906" y2="1487.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="826.5" y="1482.8247">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="847.5" y="1482.8247">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="369.5,1513.0234,359.5,1517.0234,369.5,1521.0234,365.5,1517.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="363.5" x2="1328.5" y1="1517.0234" y2="1517.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="375.5" y="1511.9575">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="396.5" y="1511.9575">Connect using token and forward telemetry</text><!--MD5=[8a56b36de0d607e853ed5d42ddffde41]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->dps : Register signing CA Cert (CA1)\nfor signing certificates
oem->oem : Generate bootstrap cert (DBC) signed by\nIdentity CA Cert (CA2).
note over oem,ih: CA1 and CA2 can be same or different in this case\nbecause device does not have the CA cert
oem->dps : Create group enrollment with Idenity CA Certificate (CA2) 
oem->device : Install DBC on the device (file system or HSM) 
end

group Device setup and configuration
oem->ie : Configure device to sign certificates using DPS as a CA
oem->ie : Configure device for DPS provisioning
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end

group Device running
oem -> ie : Start IoT Edge runtime
ie -> ie : Generate CSR for device identity cert (DIdC)
ie -> dps : Provision device with DBC\n+CSR for DIdC
dps -> ih : Create device with\nthumbprint based auth
ih - -> dps : Device info
dps - -> ie : Provisioning info\n(IoTHub + deviceId + signed DIdC)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate CSR for server cert
ie -> dps : CSR for server cert 
dps - -> ie : Cert signed with CA1
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate CSR for client cert
ie -> dps : CSR for client cert
dps - -> ie : Cert signed with CA1
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie - -> eh : Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
ie - -> eh : Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.09beta11(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>