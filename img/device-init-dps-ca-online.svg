<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1622px" preserveAspectRatio="none" style="width:1699px;height:1622px;" version="1.1" viewBox="0 0 1699 1622" width="1699px" zoomAndPan="magnify"><defs><filter height="300%" id="f1o0tz9t8572z9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1607.75" style="stroke: #A80036; stroke-width: 1.0;" width="916.5" x="766" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="1199.75" y="16.0669">Device</text><rect fill="#FFFFFF" filter="url(#f1o0tz9t8572z9)" height="246.3281" style="stroke: #000000; stroke-width: 2.0;" width="566.5" x="13" y="91.7266"/><rect fill="#FFFFFF" filter="url(#f1o0tz9t8572z9)" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="847" x="13" y="352.0547"/><rect fill="#FFFFFF" filter="url(#f1o0tz9t8572z9)" height="1054.4375" style="stroke: #000000; stroke-width: 2.0;" width="1675.5" x="13" y="485.7188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="65" x2="65" y1="74.7266" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="353" x2="353" y1="74.7266" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="445" x2="445" y1="74.7266" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="545.5" x2="545.5" y1="74.7266" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="810" x2="810" y1="74.7266" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1120" x2="1120" y1="768.6953" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1312" x2="1312" y1="944.6563" y2="1557.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1641.5" x2="1641.5" y1="998.1016" y2="1557.1563"/><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="23" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="30" y="59.4248">Operator</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="23" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="30" y="1576.1514">Operator</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="317" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="324" y="59.4248">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="317" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="324" y="1576.1514">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="399" y="71.4248">Edge device</text><ellipse cx="445.5" cy="42.4297" fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="433.5" x2="457.5" y1="56.4297" y2="56.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="399" y="1569.1514">Edge device</text><ellipse cx="445.5" cy="1588.4531" fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="433.5" x2="457.5" y1="1602.4531" y2="1602.4531"/><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="522.5" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="529.5" y="59.4248">DPS</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="522.5" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="529.5" y="1576.1514">DPS</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="770" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="777" y="43.1279">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="779.5" y="59.4248">runtime</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="770" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="777" y="1576.1514">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="779.5" y="1592.4482">runtime</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="1071" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="1078" y="1576.1514">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="1271" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1278" y="1576.1514">EdgeHub</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1605.5" y="1556.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1612.5" y="1576.1514">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1614.5" y="1592.4482">Module</text><path d="M13,91.7266 L150,91.7266 L150,98.7266 L140,108.7266 L13,108.7266 L13,91.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="246.3281" style="stroke: #000000; stroke-width: 2.0;" width="566.5" x="13" y="91.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="28" y="104.7935">Initial Setup</text><polygon fill="#A80036" points="534,141.125,544,145.125,534,149.125,538,145.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="540" y1="145.125" y2="145.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="132.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="85" y="124.9263">Register signing CA Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="85" y="140.0591">for signing certificates</text><polygon fill="#A80036" points="534,185.3906,544,189.3906,534,193.3906,538,189.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="540" y1="189.3906" y2="189.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="176.7583">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="85" y="169.1919">Register Idenity CA Certificate (CA2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="89" y="184.3247">and create group enrollment with CA2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="107" y1="233.6563" y2="233.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107" x2="107" y1="233.6563" y2="246.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="66" x2="107" y1="246.6563" y2="246.6563"/><polygon fill="#A80036" points="76,242.6563,66,246.6563,76,250.6563,72,246.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="72" y="221.0239">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="84" y="213.4575">Generate bootstrap cert (DBC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="84" y="228.5903">Identity CA Cert (CA2).</text><path d="M28,259.6563 L28,299.6563 L389,299.6563 L389,269.6563 L379,259.6563 L28,259.6563 " fill="#FBFB77" filter="url(#f1o0tz9t8572z9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M379,259.6563 L379,269.6563 L389,269.6563 L379,259.6563 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="40.5" y="276.7231">CA1 and CA2 can be same or different in this case</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="40.5" y="291.856">because device does not have the CA cert</text><polygon fill="#A80036" points="433.5,326.0547,443.5,330.0547,433.5,334.0547,437.5,330.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="439.5" y1="330.0547" y2="330.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="324.9888">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="85" y="324.9888">Install DBC on the device (file system or HSM)</text><path d="M13,352.0547 L295,352.0547 L295,359.0547 L285,369.0547 L13,369.0547 L13,352.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="847" x="13" y="352.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="28" y="365.1216">Device setup and configuration</text><polygon fill="#A80036" points="798,386.3203,808,390.3203,798,394.3203,802,390.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="804" y1="390.3203" y2="390.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="385.2544">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="85" y="385.2544">Configure device to sign certificates using DPS as a CA</text><polygon fill="#A80036" points="798,415.4531,808,419.4531,798,423.4531,802,419.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="804" y1="419.4531" y2="419.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="414.3872">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="85" y="414.3872">Configure device for DPS provisioning</text><polygon fill="#A80036" points="798,459.7188,808,463.7188,798,467.7188,802,463.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="804" y1="463.7188" y2="463.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="451.0864">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="608" x="85" y="443.52">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="85" y="458.6528">Configure EH Bridge to send telemetry upstream.</text><path d="M13,485.7188 L168,485.7188 L168,492.7188 L158,502.7188 L13,502.7188 L13,485.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1054.4375" style="stroke: #000000; stroke-width: 2.0;" width="1675.5" x="13" y="485.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="28" y="498.7856">Device running</text><polygon fill="#A80036" points="798,519.9844,808,523.9844,798,527.9844,802,523.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="65" x2="804" y1="523.9844" y2="523.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="72" y="518.9185">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="85" y="518.9185">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="852" y1="553.1172" y2="553.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="852" x2="852" y1="553.1172" y2="566.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="811" x2="852" y1="566.1172" y2="566.1172"/><polygon fill="#A80036" points="821,562.1172,811,566.1172,821,570.1172,817,566.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="548.0513">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="830" y="548.0513">Generate CSR for device identity cert (DIdC)</text><polygon fill="#A80036" points="557,606.3828,547,610.3828,557,614.3828,553,610.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="551" x2="809" y1="610.3828" y2="610.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="563" y="597.7505">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="586" y="590.1841">Provision device with DBC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="586" y="605.3169">+CSR for DIdC</text><polygon fill="#A80036" points="364,650.6484,354,654.6484,364,658.6484,360,654.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="358" x2="545" y1="654.6484" y2="654.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="370" y="642.0161">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="392" y="634.4497">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="392" y="649.5825">thumbprint based auth</text><polygon fill="#A80036" points="534,679.7813,544,683.7813,534,687.7813,538,683.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="353" x2="540" y1="683.7813" y2="683.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="360" y="678.7153">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="382" y="678.7153">Device info</text><polygon fill="#A80036" points="798,724.0469,808,728.0469,798,732.0469,802,728.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="546" x2="804" y1="728.0469" y2="728.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="553" y="715.4146">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="574" y="707.8481">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="574" y="722.981">(IoTHub + deviceId + signed DIdC)</text><polygon fill="#A80036" points="1059,753.1797,1069,757.1797,1059,761.1797,1063,757.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1065" y1="757.1797" y2="757.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="752.1138">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="839" y="752.1138">Create and start</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="1071" y="736.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="1078" y="756.042">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1120" x2="1162" y1="802.4766" y2="802.4766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1162" x2="1162" y1="802.4766" y2="815.4766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1121" x2="1162" y1="815.4766" y2="815.4766"/><polygon fill="#A80036" points="1131,811.4766,1121,815.4766,1131,819.4766,1127,815.4766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1127" y="797.4106">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="1149" y="797.4106">Process deployment</text><polygon fill="#A80036" points="821,855.7422,811,859.7422,821,863.7422,817,859.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="815" x2="1119" y1="859.7422" y2="859.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="847.1099">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="849" y="839.5435">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="849" y="854.6763">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="364,900.0078,354,904.0078,364,908.0078,360,904.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="358" x2="809" y1="904.0078" y2="904.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="370" y="891.3755">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="392" y="883.8091">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="392" y="898.9419">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1259,929.1406,1269,933.1406,1259,937.1406,1263,933.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1120" x2="1265" y1="933.1406" y2="933.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1127" y="928.0747">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1149" y="928.0747">Create and start</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="1271" y="912.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1278" y="932.0029">EdgeHub</text><polygon fill="#A80036" points="1593.5,974.4375,1603.5,978.4375,1593.5,982.4375,1597.5,978.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1120" x2="1599.5" y1="978.4375" y2="978.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1127" y="973.3716">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1149" y="973.3716">Create and start</text><rect fill="#FEFECE" filter="url(#f1o0tz9t8572z9)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1605.5" y="957.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1612.5" y="977.2998">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1614.5" y="993.5967">Module</text><polygon fill="#A80036" points="821,1036.0313,811,1040.0313,821,1044.0313,817,1040.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="815" x2="1311" y1="1040.0313" y2="1040.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="827" y="1034.9653">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="850" y="1034.9653">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="852" y1="1069.1641" y2="1069.1641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="852" x2="852" y1="1069.1641" y2="1082.1641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="811" x2="852" y1="1082.1641" y2="1082.1641"/><polygon fill="#A80036" points="821,1078.1641,811,1082.1641,821,1086.1641,817,1082.1641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1064.0981">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="839" y="1064.0981">Generate CSR for server cert</text><polygon fill="#A80036" points="557,1107.2969,547,1111.2969,557,1115.2969,553,1111.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="551" x2="809" y1="1111.2969" y2="1111.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="563" y="1106.231">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="585" y="1106.231">CSR for server cert</text><polygon fill="#A80036" points="798,1136.4297,808,1140.4297,798,1144.4297,802,1140.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="546" x2="804" y1="1140.4297" y2="1140.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="553" y="1135.3638">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="574" y="1135.3638">Cert signed with CA1</text><polygon fill="#A80036" points="1300,1165.5625,1310,1169.5625,1300,1173.5625,1304,1169.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810" x2="1306" y1="1169.5625" y2="1169.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1164.4966">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="839" y="1164.4966">Server cert</text><polygon fill="#A80036" points="821,1194.6953,811,1198.6953,821,1202.6953,817,1198.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="815" x2="1641" y1="1198.6953" y2="1198.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="1193.6294">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="849" y="1193.6294">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="852" y1="1227.8281" y2="1227.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="852" x2="852" y1="1227.8281" y2="1240.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="811" x2="852" y1="1240.8281" y2="1240.8281"/><polygon fill="#A80036" points="821,1236.8281,811,1240.8281,821,1244.8281,817,1240.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1222.7622">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="839" y="1222.7622">Generate CSR for client cert</text><polygon fill="#A80036" points="557,1265.9609,547,1269.9609,557,1273.9609,553,1269.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="551" x2="809" y1="1269.9609" y2="1269.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="563" y="1264.895">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="585" y="1264.895">CSR for client cert</text><polygon fill="#A80036" points="798,1295.0938,808,1299.0938,798,1303.0938,802,1299.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="546" x2="804" y1="1299.0938" y2="1299.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="553" y="1294.0278">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="575" y="1294.0278">Cert signed with CA1</text><polygon fill="#A80036" points="1630,1324.2266,1640,1328.2266,1630,1332.2266,1634,1328.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810" x2="1636" y1="1328.2266" y2="1328.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1323.1606">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="839" y="1323.1606">Module local identity</text><polygon fill="#A80036" points="1323,1353.3594,1313,1357.3594,1323,1361.3594,1319,1357.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1317" x2="1641" y1="1357.3594" y2="1357.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1329" y="1352.2935">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="1351" y="1352.2935">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1323,1382.4922,1313,1386.4922,1323,1390.4922,1319,1386.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1317" x2="1641" y1="1386.4922" y2="1386.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1329" y="1381.4263">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1350" y="1381.4263">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="821,1411.625,811,1415.625,821,1419.625,817,1415.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="815" x2="1311" y1="1415.625" y2="1415.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="827" y="1410.5591">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="848" y="1410.5591">Get IoTHub identity</text><polygon fill="#A80036" points="1300,1440.7578,1310,1444.7578,1300,1448.7578,1304,1444.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810" x2="1306" y1="1444.7578" y2="1444.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="817" y="1439.6919">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428" x="837" y="1439.6919">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="821,1469.8906,811,1473.8906,821,1477.8906,817,1473.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="815" x2="1311" y1="1473.8906" y2="1473.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="827" y="1468.8247">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="848" y="1468.8247">Sign token</text><polygon fill="#A80036" points="1300,1499.0234,1310,1503.0234,1300,1507.0234,1304,1503.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810" x2="1306" y1="1503.0234" y2="1503.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="817" y="1497.9575">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="838" y="1497.9575">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="364,1528.1563,354,1532.1563,364,1536.1563,360,1532.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="358" x2="1311" y1="1532.1563" y2="1532.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="370" y="1527.0903">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="391" y="1527.0903">Connect using token and forward telemetry</text><!--MD5=[c8574b671ac25995d0d242807608acbd]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->dps : Register signing CA Cert (CA1)\nfor signing certificates
oem->dps : Register Idenity CA Certificate (CA2)\n and create group enrollment with CA2
oem->oem : Generate bootstrap cert (DBC) signed by\nIdentity CA Cert (CA2).
note over oem,ih: CA1 and CA2 can be same or different in this case\nbecause device does not have the CA cert 
oem->device : Install DBC on the device (file system or HSM) 
end

group Device setup and configuration
oem->ie : Configure device to sign certificates using DPS as a CA
oem->ie : Configure device for DPS provisioning
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end

group Device running
oem -> ie : Start IoT Edge runtime
ie -> ie : Generate CSR for device identity cert (DIdC)
ie -> dps : Provision device with DBC\n+CSR for DIdC
dps -> ih : Create device with\nthumbprint based auth
ih - -> dps : Device info
dps - -> ie : Provisioning info\n(IoTHub + deviceId + signed DIdC)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate CSR for server cert
ie -> dps : CSR for server cert 
dps - -> ie : Cert signed with CA1
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate CSR for client cert
ie -> dps : CSR for client cert
dps - -> ie : Cert signed with CA1
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie - -> eh : Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
ie - -> eh : Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.09beta15(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>