<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1876px" preserveAspectRatio="none" style="width:2192px;height:1876px;" version="1.1" viewBox="0 0 2192 1876" width="2192px" zoomAndPan="magnify"><defs><filter height="300%" id="ftgvukk1jcgl8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1861.6641" style="stroke: #A80036; stroke-width: 1.0;" width="1077.5" x="1097.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="1611.75" y="16.0669">Device</text><rect fill="#FFFFFF" filter="url(#ftgvukk1jcgl8)" height="233.3281" style="stroke: #000000; stroke-width: 2.0;" width="864.5" x="13" y="91.7266"/><rect fill="#FFFFFF" filter="url(#ftgvukk1jcgl8)" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="1176.5" x="13" y="339.0547"/><rect fill="#FFFFFF" filter="url(#ftgvukk1jcgl8)" height="938.3594" style="stroke: #000000; stroke-width: 2.0;" width="2168" x="13" y="472.7188"/><rect fill="#FFFFFF" filter="url(#ftgvukk1jcgl8)" height="368.9922" style="stroke: #000000; stroke-width: 2.0;" width="1745.5" x="104" y="1425.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63" x2="63" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="63" x2="63" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63" x2="63" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="63" x2="63" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63" x2="63" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="63" x2="63" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63" x2="63" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149" x2="149" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="149" x2="149" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149" x2="149" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="149" x2="149" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149" x2="149" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="149" x2="149" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149" x2="149" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="405" x2="405" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="405" x2="405" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="405" x2="405" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="405" x2="405" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="405" x2="405" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="405" x2="405" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="405" x2="405" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543" x2="543" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="543" x2="543" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543" x2="543" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="543" x2="543" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543" x2="543" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="543" x2="543" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543" x2="543" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845.5" x2="845.5" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="845.5" x2="845.5" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845.5" x2="845.5" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="845.5" x2="845.5" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845.5" x2="845.5" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="845.5" x2="845.5" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845.5" x2="845.5" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1140.5" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1140.5" x2="1140.5" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1140.5" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1140.5" x2="1140.5" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1140.5" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1140.5" x2="1140.5" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1140.5" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1455.5" y1="74.7266" y2="793.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1455.5" x2="1455.5" y1="793.1797" y2="833.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1455.5" y1="833.9844" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1455.5" x2="1455.5" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1455.5" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1455.5" x2="1455.5" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1455.5" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1799.5" x2="1799.5" y1="937.8984" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1799.5" x2="1799.5" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1799.5" x2="1799.5" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1799.5" x2="1799.5" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1799.5" x2="1799.5" y1="1411.0781" y2="1811.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2134" x2="2134" y1="991.3438" y2="1329.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2134" x2="2134" y1="1329.4688" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2134" x2="2134" y1="1370.2734" y2="1370.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="2134" x2="2134" y1="1370.2734" y2="1411.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2134" x2="2134" y1="1411.0781" y2="1811.0703"/><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="23" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="30" y="59.4248">Operator</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="23" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="30" y="1830.0654">Operator</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="114" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="121" y="59.4248">IoT Hub</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="114" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="121" y="1830.0654">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="360" y="71.4248">Edge device</text><ellipse cx="405.5" cy="42.4297" fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="393.5" x2="417.5" y1="56.4297" y2="56.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="360" y="1823.0654">Edge device</text><ellipse cx="405.5" cy="1842.3672" fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="393.5" x2="417.5" y1="1856.3672" y2="1856.3672"/><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="461" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="513.5" y="43.1279">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="468" y="59.4248">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="461" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="513.5" y="1830.0654">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="468" y="1846.3623">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="823.5" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="830.5" y="59.4248">EST</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="823.5" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="830.5" y="1830.0654">EST</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="1101.5" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="1108.5" y="43.1279">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1112" y="59.4248">runtime</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="1101.5" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="1108.5" y="1830.0654">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1112" y="1846.3623">runtime</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1407.5" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1414.5" y="59.4248">EdgeAgent</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1407.5" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1414.5" y="1830.0654">EdgeAgent</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1759.5" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1766.5" y="1830.0654">EdgeHub</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="2098" y="1810.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="2105" y="1830.0654">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="2108" y="1846.3623">Module</text><path d="M13,91.7266 L149,91.7266 L149,98.7266 L139,108.7266 L13,108.7266 L13,91.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="233.3281" style="stroke: #000000; stroke-width: 2.0;" width="864.5" x="13" y="91.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="28" y="104.7935">Initial Setup</text><polygon fill="#A80036" points="833.5,141.125,843.5,145.125,833.5,149.125,837.5,145.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="839.5" y1="145.125" y2="145.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="132.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="83.5" y="124.9263">Register CA signing Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="83.5" y="140.0591">for signing certificates</text><polygon fill="#A80036" points="833.5,185.3906,843.5,189.3906,833.5,193.3906,837.5,189.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="839.5" y1="189.3906" y2="189.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="176.7583">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="83.5" y="169.1919">Register Identity CA Cert (CA2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="83.5" y="184.3247">for signing identity certificates</text><path d="M23,202.3906 L23,242.3906 L446,242.3906 L446,212.3906 L436,202.3906 L23,202.3906 " fill="#FBFB77" filter="url(#ftgvukk1jcgl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M436,202.3906 L436,212.3906 L446,212.3906 L436,202.3906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="52" y="219.4575">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="52" y="234.5903">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="833.5,283.9219,843.5,287.9219,833.5,291.9219,837.5,287.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="839.5" y1="287.9219" y2="287.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="70.5" y="275.2896">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="82.5" y="267.7231">Register EST authentication cert ESTC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="82.5" y="282.856">(Used to authenticate against the EST server)</text><polygon fill="#A80036" points="393.5,313.0547,403.5,317.0547,393.5,321.0547,397.5,317.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="399.5" y1="317.0547" y2="317.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="311.9888">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="83.5" y="311.9888">Install ESTC on the device (file system or HSM)</text><path d="M13,339.0547 L295,339.0547 L295,346.0547 L285,356.0547 L13,356.0547 L13,339.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="1176.5" x="13" y="339.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="28" y="352.1216">Device setup and configuration</text><polygon fill="#A80036" points="1128.5,373.3203,1138.5,377.3203,1128.5,381.3203,1132.5,377.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="1134.5" y1="377.3203" y2="377.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="372.2544">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="83.5" y="372.2544">Configure device to sign certificates using EST server</text><polygon fill="#A80036" points="1128.5,402.4531,1138.5,406.4531,1128.5,410.4531,1132.5,406.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="1134.5" y1="406.4531" y2="406.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="401.3872">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="83.5" y="401.3872">Configure device for external provisioning mode</text><polygon fill="#A80036" points="1128.5,446.7188,1138.5,450.7188,1128.5,454.7188,1132.5,450.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="1134.5" y1="450.7188" y2="450.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="438.0864">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="611" x="83.5" y="430.52">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="83.5" y="445.6528">Configure EH Bridge to send telemetry upstream.</text><path d="M13,472.7188 L162,472.7188 L162,479.7188 L152,489.7188 L13,489.7188 L13,472.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="938.3594" style="stroke: #000000; stroke-width: 2.0;" width="2168" x="13" y="472.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="28" y="485.7856">Device offline</text><polygon fill="#A80036" points="1128.5,506.9844,1138.5,510.9844,1128.5,514.9844,1132.5,510.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="63.5" x2="1134.5" y1="510.9844" y2="510.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="70.5" y="505.9185">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="83.5" y="505.9185">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1182.5" y1="540.1172" y2="540.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1182.5" x2="1182.5" y1="540.1172" y2="553.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141.5" x2="1182.5" y1="553.1172" y2="553.1172"/><polygon fill="#A80036" points="1151.5,549.1172,1141.5,553.1172,1151.5,557.1172,1147.5,553.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1147.5" y="535.0513">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="1160.5" y="535.0513">Generate CSR to get device CA cert (DCAC)</text><polygon fill="#A80036" points="856.5,578.25,846.5,582.25,856.5,586.25,852.5,582.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="850.5" x2="1139.5" y1="582.25" y2="582.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="862.5" y="577.1841">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="885.5" y="577.1841">CSR for CA cert</text><polygon fill="#A80036" points="1128.5,607.3828,1138.5,611.3828,1128.5,615.3828,1132.5,611.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="845.5" x2="1134.5" y1="611.3828" y2="611.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="852.5" y="606.3169">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="874.5" y="606.3169">Device CA Cert DCAC signed with CA1</text><polygon fill="#A80036" points="554.5,651.6484,544.5,655.6484,554.5,659.6484,550.5,655.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="1139.5" y1="655.6484" y2="655.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="560.5" y="643.0161">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="582.5" y="635.4497">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="582.5" y="650.5825">(external provisioning endpoint)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="684.7813" y2="684.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="684.7813" y2="697.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="697.7813" y2="697.7813"/><polygon fill="#A80036" points="554.5,693.7813,544.5,697.7813,554.5,701.7813,550.5,697.7813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="550.5" y="679.7153">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="571.5" y="679.7153">Generate CSR to get idenitity cert (DIdC)</text><polygon fill="#A80036" points="833.5,722.9141,843.5,726.9141,833.5,730.9141,837.5,726.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="839.5" y1="726.9141" y2="726.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="550.5" y="721.8481">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="572.5" y="721.8481">CSR for identity cert</text><polygon fill="#A80036" points="554.5,752.0469,544.5,756.0469,554.5,760.0469,550.5,756.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="844.5" y1="756.0469" y2="756.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="560.5" y="750.981">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="582.5" y="750.981">Identity cert DIdC signed with CA2</text><polygon fill="#FF0000" points="1128.5,781.1797,1138.5,785.1797,1128.5,789.1797,1132.5,785.1797" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="543.5" x2="1134.5" y1="785.1797" y2="785.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="550.5" y="780.1138">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="572.5" y="780.1138">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="248" x="975" y="817.3901">Provisioning attempts continue till success</text><polygon fill="#A80036" points="1443.5,851.1172,1453.5,855.1172,1443.5,859.1172,1447.5,855.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1449.5" y1="855.1172" y2="855.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1147.5" y="850.0513">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1169.5" y="850.0513">Create and start</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1497.5" y1="884.25" y2="884.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1497.5" x2="1497.5" y1="884.25" y2="897.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1456.5" x2="1497.5" y1="897.25" y2="897.25"/><polygon fill="#A80036" points="1466.5,893.25,1456.5,897.25,1466.5,901.25,1462.5,897.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1462.5" y="879.1841">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1484.5" y="879.1841">Process deployment</text><polygon fill="#A80036" points="1747.5,922.3828,1757.5,926.3828,1747.5,930.3828,1751.5,926.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1753.5" y1="926.3828" y2="926.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1462.5" y="921.3169">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="1484.5" y="921.3169">Create with local configuration and start</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1759.5" y="905.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1766.5" y="925.2451">EdgeHub</text><polygon fill="#A80036" points="2086,967.6797,2096,971.6797,2086,975.6797,2090,971.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="2092" y1="971.6797" y2="971.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="1462.5" y="966.6138">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1485.5" y="966.6138">Create and start</text><rect fill="#FEFECE" filter="url(#ftgvukk1jcgl8)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="2098" y="950.5469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="2105" y="970.542">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="2108" y="986.8389">Module</text><polygon fill="#A80036" points="1151.5,1029.2734,1141.5,1033.2734,1151.5,1037.2734,1147.5,1033.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1145.5" x2="1798.5" y1="1033.2734" y2="1033.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1157.5" y="1028.2075">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="1179.5" y="1028.2075">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1182.5" y1="1062.4063" y2="1062.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1182.5" x2="1182.5" y1="1062.4063" y2="1075.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141.5" x2="1182.5" y1="1075.4063" y2="1075.4063"/><polygon fill="#A80036" points="1151.5,1071.4063,1141.5,1075.4063,1151.5,1079.4063,1147.5,1075.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1147.5" y="1057.3403">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1169.5" y="1057.3403">Generate server cert from DCAC</text><polygon fill="#A80036" points="1787.5,1100.5391,1797.5,1104.5391,1787.5,1108.5391,1791.5,1104.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1140.5" x2="1793.5" y1="1104.5391" y2="1104.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1147.5" y="1099.4731">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="1168.5" y="1099.4731">Server cert</text><polygon fill="#A80036" points="1151.5,1129.6719,1141.5,1133.6719,1151.5,1137.6719,1147.5,1133.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1145.5" x2="2133.5" y1="1133.6719" y2="1133.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1157.5" y="1128.606">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1179.5" y="1128.606">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1140.5" x2="1182.5" y1="1162.8047" y2="1162.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1182.5" x2="1182.5" y1="1162.8047" y2="1175.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141.5" x2="1182.5" y1="1175.8047" y2="1175.8047"/><polygon fill="#A80036" points="1151.5,1171.8047,1141.5,1175.8047,1151.5,1179.8047,1147.5,1175.8047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1147.5" y="1157.7388">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="1169.5" y="1157.7388">Generate client cert from DCAC</text><polygon fill="#A80036" points="2122.5,1200.9375,2132.5,1204.9375,2122.5,1208.9375,2126.5,1204.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1140.5" x2="2128.5" y1="1204.9375" y2="1204.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1147.5" y="1199.8716">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1169.5" y="1199.8716">Module local identity</text><polygon fill="#A80036" points="1810.5,1230.0703,1800.5,1234.0703,1810.5,1238.0703,1806.5,1234.0703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1804.5" x2="2133.5" y1="1234.0703" y2="1234.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1816.5" y="1229.0044">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1838.5" y="1229.0044">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1810.5,1259.2031,1800.5,1263.2031,1810.5,1267.2031,1806.5,1263.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1804.5" x2="2133.5" y1="1263.2031" y2="1263.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1816.5" y="1258.1372">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1838.5" y="1258.1372">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="1151.5,1288.3359,1141.5,1292.3359,1151.5,1296.3359,1147.5,1292.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1145.5" x2="1798.5" y1="1292.3359" y2="1292.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1157.5" y="1287.27">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1179.5" y="1287.27">Get IoTHub identity</text><polygon fill="#FF0000" points="1787.5,1317.4688,1797.5,1321.4688,1787.5,1325.4688,1791.5,1321.4688" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1140.5" x2="1793.5" y1="1321.4688" y2="1321.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1147.5" y="1316.4028">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1169.5" y="1316.4028">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="330" x="934" y="1353.6792">EdgeHub continues to ask for IoTHub identity periodically</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="343" x="927.5" y="1394.4839">App operation continues. EdgeHub stores telemetry locally</text><path d="M104,1425.0781 L289,1425.0781 L289,1432.0781 L279,1442.0781 L104,1442.0781 L104,1425.0781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="368.9922" style="stroke: #000000; stroke-width: 2.0;" width="1745.5" x="104" y="1425.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="119" y="1438.145">Device goes online</text><polygon fill="#A80036" points="554.5,1474.4766,544.5,1478.4766,554.5,1482.4766,550.5,1478.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="1139.5" y1="1478.4766" y2="1478.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="560.5" y="1465.8442">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="581.5" y="1458.2778">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="581.5" y="1473.4106">(external provisioning endpoint)</text><polygon fill="#A80036" points="160,1518.7422,150,1522.7422,160,1526.7422,156,1522.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="154" x2="542.5" y1="1522.7422" y2="1522.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="166" y="1510.1099">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="187" y="1502.5435">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="187" y="1517.6763">CA based auth</text><polygon fill="#A80036" points="531.5,1547.875,541.5,1551.875,531.5,1555.875,535.5,1551.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="149" x2="537.5" y1="1551.875" y2="1551.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="156" y="1546.8091">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="176" y="1546.8091">Device info</text><polygon fill="#A80036" points="1128.5,1592.1406,1138.5,1596.1406,1128.5,1600.1406,1132.5,1596.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="543.5" x2="1134.5" y1="1596.1406" y2="1596.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="550.5" y="1583.5083">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="571.5" y="1575.9419">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="571.5" y="1591.0747">(IoTHub + deviceId + DIdC)</text><polygon fill="#A80036" points="160,1636.4063,150,1640.4063,160,1644.4063,156,1640.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="154" x2="1139.5" y1="1640.4063" y2="1640.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="166" y="1627.7739">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="187" y="1620.2075">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="187" y="1635.3403">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1151.5,1665.5391,1141.5,1669.5391,1151.5,1673.5391,1147.5,1669.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1145.5" x2="1798.5" y1="1669.5391" y2="1669.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1157.5" y="1664.4731">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1178.5" y="1664.4731">Get IoTHub identity</text><polygon fill="#A80036" points="1787.5,1694.6719,1797.5,1698.6719,1787.5,1702.6719,1791.5,1698.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1140.5" x2="1793.5" y1="1698.6719" y2="1698.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1147.5" y="1693.606">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="1168.5" y="1693.606">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="1151.5,1723.8047,1141.5,1727.8047,1151.5,1731.8047,1147.5,1727.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1145.5" x2="1798.5" y1="1727.8047" y2="1727.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1157.5" y="1722.7388">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="1178.5" y="1722.7388">Sign token</text><polygon fill="#A80036" points="1787.5,1752.9375,1797.5,1756.9375,1787.5,1760.9375,1791.5,1756.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1140.5" x2="1793.5" y1="1756.9375" y2="1756.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1147.5" y="1751.8716">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1168.5" y="1751.8716">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="160,1782.0703,150,1786.0703,160,1790.0703,156,1786.0703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="154" x2="1798.5" y1="1786.0703" y2="1786.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="166" y="1781.0044">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="189" y="1781.0044">Connect using token and forward telemetry</text><!--MD5=[8e1fee7d7d968e9769ee92a4f348c436]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "External\nProvisioning endpoint" as ae
participant "EST" as est

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->est : Register CA signing Cert (CA1)\nfor signing certificates
oem->est : Register Identity CA Cert (CA2)\nfor signing identity certificates
note over oem, device: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->est : Register EST authentication cert ESTC\n(Used to authenticate against the EST server)
oem->device : Install ESTC on the device (file system or HSM)
end 

group Device setup and configuration
oem->ie : Configure device to sign certificates using EST server
oem->ie : Configure device for external provisioning mode
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end

group Device offline
oem -> ie : Start IoT Edge runtime

ie -> ie : Generate CSR to get device CA cert (DCAC)
ie -> est : CSR for CA cert
return Device CA Cert DCAC signed with CA1

ie -> ae : Provision device\n(external provisioning endpoint)
ae -> ae : Generate CSR to get idenitity cert (DIdC)
ae -> est : CSR for identity cert
return Identity cert DIdC signed with CA2
ae -[#red]-> ie : Failure
... Provisioning attempts continue till success ... 

ie -> ea ** : Create and start
ea -> ea : Process deployment

ea -> eh ** : Create with local configuration and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie -[#red]-> eh : Failure
... EdgeHub continues to ask for IoTHub identity periodically ... 

... App operation continues. EdgeHub stores telemetry locally ... 
end 

group Device goes online
ie -> ae : Provision device\n(external provisioning endpoint)
ae -> ih : Create device with\nCA based auth
return Device info
ae - -> ie: Provisioning info\n(IoTHub + deviceId + DIdC)

ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.09beta11(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>