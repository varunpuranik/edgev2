<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1700px" preserveAspectRatio="none" style="width:1727px;height:1700px;" version="1.1" viewBox="0 0 1727 1700" width="1727px" zoomAndPan="magnify"><defs><filter height="300%" id="f2a2wicjmfabo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1685.9688" style="stroke: #A80036; stroke-width: 1.0;" width="855" x="855.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="1261" y="16.0605">Device</text><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="292.8125" style="stroke: #000000; stroke-width: 2.0;" width="653.5" x="12" y="92.0469"/><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="104.9375" style="stroke: #000000; stroke-width: 2.0;" width="798.5" x="145" y="398.8594"/><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="1100.3594" style="stroke: #000000; stroke-width: 2.0;" width="1571.5" x="145" y="517.7969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="193" x2="193" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="276" x2="276" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="505.5" x2="505.5" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="578.5" x2="578.5" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="633.5" x2="633.5" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="896.5" x2="896.5" y1="75.0469" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1183.5" x2="1183.5" y1="961.0156" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1355.5" x2="1355.5" y1="1137.5938" y2="1635.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1670.5" x2="1670.5" y1="1191.2031" y2="1635.1563"/><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="155" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="162" y="59.6289">Operator</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="155" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="162" y="1654.1445">Operator</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="242" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="249" y="59.6289">IoT Hub</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="242" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="249" y="1654.1445">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="464.5" y="71.6289">Edge device</text><ellipse cx="505.5" cy="42.6406" fill="#FEFECE" filter="url(#f2a2wicjmfabo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="493.5" x2="517.5" y1="56.6406" y2="56.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="464.5" y="1647.1445">Edge device</text><ellipse cx="505.5" cy="1666.5625" fill="#FEFECE" filter="url(#f2a2wicjmfabo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="493.5" x2="517.5" y1="1680.5625" y2="1680.5625"/><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="556.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="563.5" y="59.6289">DPS</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="556.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="563.5" y="1654.1445">DPS</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="611.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="618.5" y="59.6289">EST</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="611.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="618.5" y="1654.1445">EST</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="859.5" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="866.5" y="43.2227">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="869" y="59.6289">runtime</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="859.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="866.5" y="1654.1445">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="869" y="1670.5508">runtime</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1139.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1146.5" y="1654.1445">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1318.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1325.5" y="1654.1445">EdgeHub</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1635.5" y="1634.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1642.5" y="1654.1445">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1645" y="1670.5508">Module</text><path d="M12,92.0469 L137,92.0469 L137,99.0469 L127,109.0469 L12,109.0469 L12,92.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="292.8125" style="stroke: #000000; stroke-width: 2.0;" width="653.5" x="12" y="92.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="27" y="105.1074">Initial Setup</text><polygon fill="#A80036" points="621.5,141.75,631.5,145.75,621.5,149.75,625.5,145.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="627.5" y1="145.75" y2="145.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="132.959">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="211.5" y="125.3418">Register CA signing Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="211.5" y="140.5762">for signing certificates</text><polygon fill="#A80036" points="621.5,186.2188,631.5,190.2188,621.5,194.2188,625.5,190.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="627.5" y1="190.2188" y2="190.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="177.4277">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="211.5" y="169.8105">Register Identity CA Cert (CA2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="211.5" y="185.0449">for signing identity certificates</text><path d="M22,203.2188 L22,243.2188 L360,243.2188 L360,213.2188 L350,203.2188 L22,203.2188 " fill="#FBFB77" filter="url(#f2a2wicjmfabo)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M350,203.2188 L350,213.2188 L360,213.2188 L350,203.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="28" y="220.2793">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="28" y="235.5137">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="621.5,285.1563,631.5,289.1563,621.5,293.1563,625.5,289.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="627.5" y1="289.1563" y2="289.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="276.3652">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="211.5" y="268.748">Register EST authentication cert ESTC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="211.5" y="283.9824">(Used to authenticate against the EST server)</text><polygon fill="#A80036" points="567,314.3906,577,318.3906,567,322.3906,571,318.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="573" y1="318.3906" y2="318.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="313.2168">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="211.5" y="313.2168">Create group enrollment with Identity CA Certificate (CA2)</text><polygon fill="#A80036" points="493.5,343.625,503.5,347.625,493.5,351.625,497.5,347.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="499.5" y1="347.625" y2="347.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="342.4512">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="211.5" y="342.4512">Install DIdC on the device (file system or HSM)</text><polygon fill="#A80036" points="493.5,372.8594,503.5,376.8594,493.5,380.8594,497.5,376.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="499.5" y1="376.8594" y2="376.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="371.6855">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="211.5" y="371.6855">Install ESTC on the device (file system or HSM)</text><path d="M145,398.8594 L397,398.8594 L397,405.8594 L387,415.8594 L145,415.8594 L145,398.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="104.9375" style="stroke: #000000; stroke-width: 2.0;" width="798.5" x="145" y="398.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="160" y="411.9199">Device setup and configuration</text><polygon fill="#A80036" points="884.5,433.3281,894.5,437.3281,884.5,441.3281,888.5,437.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="890.5" y1="437.3281" y2="437.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="432.1543">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="211.5" y="432.1543">Configure device to sign certificates using EST server</text><polygon fill="#A80036" points="884.5,462.5625,894.5,466.5625,884.5,470.5625,888.5,466.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="890.5" y1="466.5625" y2="466.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="461.3887">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="211.5" y="461.3887">Configure device for DPS provisioning</text><polygon fill="#A80036" points="884.5,491.7969,894.5,495.7969,884.5,499.7969,888.5,495.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="890.5" y1="495.7969" y2="495.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="490.623">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="211.5" y="490.623">Configure EdgeAgent</text><path d="M145,517.7969 L287,517.7969 L287,524.7969 L277,534.7969 L145,534.7969 L145,517.7969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1100.3594" style="stroke: #000000; stroke-width: 2.0;" width="1571.5" x="145" y="517.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="160" y="530.8574">Device running</text><polygon fill="#A80036" points="884.5,552.2656,894.5,556.2656,884.5,560.2656,888.5,556.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="890.5" y1="556.2656" y2="556.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="200.5" y="551.0918">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="218.5" y="551.0918">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="896.5" x2="938.5" y1="585.5" y2="585.5"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="938.5" x2="938.5" y1="585.5" y2="598.5"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897.5" x2="938.5" y1="598.5" y2="598.5"/><polygon fill="#A80036" points="907.5,594.5,897.5,598.5,907.5,602.5,903.5,598.5" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="580.3262">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="921.5" y="580.3262">Generate CSR to get idenitity cert (DIdC)</text><polygon fill="#A80036" points="644.5,623.7344,634.5,627.7344,644.5,631.7344,640.5,627.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="638.5" x2="895.5" y1="627.7344" y2="627.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="650.5" y="622.5605">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="668.5" y="622.5605">CSR for identity cert</text><polygon fill="#A80036" points="884.5,652.9688,894.5,656.9688,884.5,660.9688,888.5,656.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="633.5" x2="890.5" y1="656.9688" y2="656.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="640.5" y="651.7949">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="658.5" y="651.7949">Identity cert DIdC signed with CA2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="896.5" x2="938.5" y1="686.2031" y2="686.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="938.5" x2="938.5" y1="686.2031" y2="699.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897.5" x2="938.5" y1="699.2031" y2="699.2031"/><polygon fill="#A80036" points="907.5,695.2031,897.5,699.2031,907.5,703.2031,903.5,699.2031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="681.0293">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="921.5" y="681.0293">Generate CSR to get device CA cert (DCAC)</text><polygon fill="#A80036" points="644.5,724.4375,634.5,728.4375,644.5,732.4375,640.5,728.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="638.5" x2="895.5" y1="728.4375" y2="728.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="650.5" y="723.2637">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="668.5" y="723.2637">CSR for CA cert</text><polygon fill="#A80036" points="884.5,753.6719,894.5,757.6719,884.5,761.6719,888.5,757.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="633.5" x2="890.5" y1="757.6719" y2="757.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="640.5" y="752.498">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="658.5" y="752.498">Device CA Cert DCAC signed with CA1</text><polygon fill="#A80036" points="590,798.1406,580,802.1406,590,806.1406,586,802.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="584" x2="895.5" y1="802.1406" y2="802.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="596" y="789.3496">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="614" y="781.7324">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="614" y="796.9668">with DIdC</text><polygon fill="#A80036" points="287.5,842.6094,277.5,846.6094,287.5,850.6094,283.5,846.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281.5" x2="578" y1="846.6094" y2="846.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="293.5" y="833.8184">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="311.5" y="826.2012">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="311.5" y="841.4355">thumbprint based auth</text><polygon fill="#A80036" points="567,871.8438,577,875.8438,567,879.8438,571,875.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="276.5" x2="573" y1="875.8438" y2="875.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="283.5" y="870.6699">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="301.5" y="870.6699">Device info</text><polygon fill="#A80036" points="884.5,916.3125,894.5,920.3125,884.5,924.3125,888.5,920.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="579" x2="890.5" y1="920.3125" y2="920.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="586" y="907.5215">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="604" y="899.9043">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="604" y="915.1387">(IoTHub + deviceId)</text><polygon fill="#A80036" points="1127.5,945.5469,1137.5,949.5469,1127.5,953.5469,1131.5,949.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="896.5" x2="1133.5" y1="949.5469" y2="949.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="944.373">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="921.5" y="944.373">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1139.5" y="928.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1146.5" y="948.3008">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1183.5" x2="1225.5" y1="994.9531" y2="994.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1225.5" x2="1225.5" y1="994.9531" y2="1007.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1184.5" x2="1225.5" y1="1007.9531" y2="1007.9531"/><polygon fill="#A80036" points="1194.5,1003.9531,1184.5,1007.9531,1194.5,1011.9531,1190.5,1007.9531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1190.5" y="989.7793">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1208.5" y="989.7793">Process deployment</text><polygon fill="#A80036" points="907.5,1048.4219,897.5,1052.4219,907.5,1056.4219,903.5,1052.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="901.5" x2="1182.5" y1="1052.4219" y2="1052.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="913.5" y="1039.6309">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="931.5" y="1032.0137">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="931.5" y="1047.248">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="287.5,1092.8906,277.5,1096.8906,287.5,1100.8906,283.5,1096.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281.5" x2="895.5" y1="1096.8906" y2="1096.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="293.5" y="1084.0996">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="311.5" y="1076.4824">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="311.5" y="1091.7168">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1306.5,1122.125,1316.5,1126.125,1306.5,1130.125,1310.5,1126.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1183.5" x2="1312.5" y1="1126.125" y2="1126.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1190.5" y="1120.9512">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1208.5" y="1120.9512">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1318.5" y="1104.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1325.5" y="1124.8789">EdgeHub</text><polygon fill="#A80036" points="1623.5,1167.5313,1633.5,1171.5313,1623.5,1175.5313,1627.5,1171.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1183.5" x2="1629.5" y1="1171.5313" y2="1171.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1190.5" y="1166.3574">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1208.5" y="1166.3574">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1635.5" y="1150.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1642.5" y="1170.2852">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1645" y="1186.6914">Module</text><polygon fill="#A80036" points="907.5,1229.3438,897.5,1233.3438,907.5,1237.3438,903.5,1233.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="901.5" x2="1355" y1="1233.3438" y2="1233.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="913.5" y="1228.1699">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="931.5" y="1228.1699">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="896.5" x2="938.5" y1="1262.5781" y2="1262.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="938.5" x2="938.5" y1="1262.5781" y2="1275.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897.5" x2="938.5" y1="1275.5781" y2="1275.5781"/><polygon fill="#A80036" points="907.5,1271.5781,897.5,1275.5781,907.5,1279.5781,903.5,1275.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1257.4043">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="921.5" y="1257.4043">Generate server cert from DCAC</text><polygon fill="#A80036" points="1344,1300.8125,1354,1304.8125,1344,1308.8125,1348,1304.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="896.5" x2="1350" y1="1304.8125" y2="1304.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1299.6387">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="921.5" y="1299.6387">Server cert</text><polygon fill="#A80036" points="907.5,1330.0469,897.5,1334.0469,907.5,1338.0469,903.5,1334.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="901.5" x2="1670" y1="1334.0469" y2="1334.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="913.5" y="1328.873">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="931.5" y="1328.873">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="896.5" x2="938.5" y1="1363.2813" y2="1363.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="938.5" x2="938.5" y1="1363.2813" y2="1376.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897.5" x2="938.5" y1="1376.2813" y2="1376.2813"/><polygon fill="#A80036" points="907.5,1372.2813,897.5,1376.2813,907.5,1380.2813,903.5,1376.2813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1358.1074">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="921.5" y="1358.1074">Generate client cert from DCAC</text><polygon fill="#A80036" points="1659,1401.5156,1669,1405.5156,1659,1409.5156,1663,1405.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="896.5" x2="1665" y1="1405.5156" y2="1405.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1400.3418">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="921.5" y="1400.3418">Module local identity</text><polygon fill="#A80036" points="1367,1430.75,1357,1434.75,1367,1438.75,1363,1434.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1361" x2="1670" y1="1434.75" y2="1434.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1373" y="1429.5762">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1391" y="1429.5762">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1367,1459.9844,1357,1463.9844,1367,1467.9844,1363,1463.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1361" x2="1670" y1="1463.9844" y2="1463.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1373" y="1458.8105">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1391" y="1458.8105">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="907.5,1489.2188,897.5,1493.2188,907.5,1497.2188,903.5,1493.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="901.5" x2="1355" y1="1493.2188" y2="1493.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="913.5" y="1488.0449">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="931.5" y="1488.0449">Get IoTHub identity</text><polygon fill="#A80036" points="1344,1518.4531,1354,1522.4531,1344,1526.4531,1348,1522.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="896.5" x2="1350" y1="1522.4531" y2="1522.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1517.2793">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="921.5" y="1517.2793">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="907.5,1547.6875,897.5,1551.6875,907.5,1555.6875,903.5,1551.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="901.5" x2="1355" y1="1551.6875" y2="1551.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="913.5" y="1546.5137">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="931.5" y="1546.5137">Sign token</text><polygon fill="#A80036" points="1344,1576.9219,1354,1580.9219,1344,1584.9219,1348,1580.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="896.5" x2="1350" y1="1580.9219" y2="1580.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="903.5" y="1575.748">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="921.5" y="1575.748">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="287.5,1606.1563,277.5,1610.1563,287.5,1614.1563,283.5,1610.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281.5" x2="1355" y1="1610.1563" y2="1610.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="293.5" y="1604.9824">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="311.5" y="1604.9824">Connect using token and forward telemetry</text><!--MD5=[e5b36628ff2ad45725c5e95ce5eaa970]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps
participant "EST" as est

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->est : Register CA signing Cert (CA1)\nfor signing certificates
oem->est : Register Identity CA Cert (CA2)\nfor signing identity certificates
note over oem: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->est : Register EST authentication cert ESTC\n(Used to authenticate against the EST server)
oem->dps : Create group enrollment with Identity CA Certificate (CA2) 
oem->device : Install DIdC on the device (file system or HSM) 
oem->device : Install ESTC on the device (file system or HSM)
end 

group Device setup and configuration
oem->ie : Configure device to sign certificates using EST server
oem->ie : Configure device for DPS provisioning
oem->ie : Configure EdgeAgent
end

group Device running
oem -> ie : Start IoT Edge runtime

ie -> ie : Generate CSR to get idenitity cert (DIdC)
ie -> est : CSR for identity cert
return Identity cert DIdC signed with CA2

ie -> ie : Generate CSR to get device CA cert (DCAC)
ie -> est : CSR for CA cert
return Device CA Cert DCAC signed with CA1

ie -> dps : Provision device\nwith DIdC
dps -> ih : Create device with\nthumbprint based auth
return Device info
dps - -> ie: Provisioning info\n(IoTHub + deviceId)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.06(Sun Apr 05 05:38:32 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.6+10-suse-3.1-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>