<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1695px" preserveAspectRatio="none" style="width:1889px;height:1695px;" version="1.1" viewBox="0 0 1889 1695" width="1889px" zoomAndPan="magnify"><defs><filter height="300%" id="f2a2wicjmfabo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1680.0156" style="stroke: #A80036; stroke-width: 1.0;" width="934.5" x="938" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="1380.75" y="16.0669">Device</text><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="291.5938" style="stroke: #000000; stroke-width: 2.0;" width="705" x="13" y="91.7266"/><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="869" x="161" y="397.3203"/><rect fill="#FFFFFF" filter="url(#f2a2wicjmfabo)" height="1096.5703" style="stroke: #000000; stroke-width: 2.0;" width="1717.5" x="161" y="515.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="211" x2="211" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="297" x2="297" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="553" x2="553" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="631" x2="631" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="686" x2="686" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="981" x2="981" y1="74.7266" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1305" x2="1305" y1="957.4922" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1498" x2="1498" y1="1133.4531" y2="1629.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1831.5" x2="1831.5" y1="1186.8984" y2="1629.4219"/><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="171" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="178" y="59.4248">Operator</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="171" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="178" y="1648.417">Operator</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="262" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="269" y="59.4248">IoT Hub</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="262" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="269" y="1648.417">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="508" y="71.4248">Edge device</text><ellipse cx="553.5" cy="42.4297" fill="#FEFECE" filter="url(#f2a2wicjmfabo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="541.5" x2="565.5" y1="56.4297" y2="56.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="508" y="1641.417">Edge device</text><ellipse cx="553.5" cy="1660.7188" fill="#FEFECE" filter="url(#f2a2wicjmfabo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="541.5" x2="565.5" y1="1674.7188" y2="1674.7188"/><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="609" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="616" y="59.4248">DPS</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="609" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="616" y="1648.417">DPS</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="664" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="671" y="59.4248">EST</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="664" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="671" y="1648.417">EST</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="942" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="949" y="43.1279">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="952.5" y="59.4248">runtime</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="942" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="949" y="1648.417">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="952.5" y="1664.7139">runtime</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1257" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1264" y="1648.417">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1458" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1465" y="1648.417">EdgeHub</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1795.5" y="1628.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1802.5" y="1648.417">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1805.5" y="1664.7139">Module</text><path d="M13,91.7266 L149,91.7266 L149,98.7266 L139,108.7266 L13,108.7266 L13,91.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="291.5938" style="stroke: #000000; stroke-width: 2.0;" width="705" x="13" y="91.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="28" y="104.7935">Initial Setup</text><polygon fill="#A80036" points="674,141.125,684,145.125,674,149.125,678,145.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="680" y1="145.125" y2="145.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="132.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="231.5" y="124.9263">Register CA signing Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="231.5" y="140.0591">for signing certificates</text><polygon fill="#A80036" points="674,185.3906,684,189.3906,674,193.3906,678,189.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="680" y1="189.3906" y2="189.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="176.7583">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="231.5" y="169.1919">Register Identity CA Cert (CA2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="231.5" y="184.3247">for signing identity certificates</text><path d="M23,202.3906 L23,242.3906 L396,242.3906 L396,212.3906 L386,202.3906 L23,202.3906 " fill="#FBFB77" filter="url(#f2a2wicjmfabo)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M386,202.3906 L386,212.3906 L396,212.3906 L386,202.3906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="29" y="219.4575">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="29" y="234.5903">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="674,283.9219,684,287.9219,674,291.9219,678,287.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="680" y1="287.9219" y2="287.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="218.5" y="275.2896">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="230.5" y="267.7231">Register EST authentication cert ESTC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="230.5" y="282.856">(Used to authenticate against the EST server)</text><polygon fill="#A80036" points="619.5,313.0547,629.5,317.0547,619.5,321.0547,623.5,317.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="625.5" y1="317.0547" y2="317.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="311.9888">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="231.5" y="311.9888">Create group enrollment with Identity CA Certificate (CA2)</text><polygon fill="#A80036" points="541.5,342.1875,551.5,346.1875,541.5,350.1875,545.5,346.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="547.5" y1="346.1875" y2="346.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="341.1216">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="231.5" y="341.1216">Install DIdC on the device (file system or HSM)</text><polygon fill="#A80036" points="541.5,371.3203,551.5,375.3203,541.5,379.3203,545.5,375.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="547.5" y1="375.3203" y2="375.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="370.2544">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="231.5" y="370.2544">Install ESTC on the device (file system or HSM)</text><path d="M161,397.3203 L443,397.3203 L443,404.3203 L433,414.3203 L161,414.3203 L161,397.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="869" x="161" y="397.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="176" y="410.3872">Device setup and configuration</text><polygon fill="#A80036" points="969,431.5859,979,435.5859,969,439.5859,973,435.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="975" y1="435.5859" y2="435.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="430.52">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="231.5" y="430.52">Configure device to sign certificates using EST server</text><polygon fill="#A80036" points="969,460.7188,979,464.7188,969,468.7188,973,464.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="975" y1="464.7188" y2="464.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="459.6528">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="231.5" y="459.6528">Configure device for DPS provisioning</text><polygon fill="#A80036" points="969,489.8516,979,493.8516,969,497.8516,973,493.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="975" y1="493.8516" y2="493.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="218.5" y="488.7856">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="231.5" y="488.7856">Configure EdgeAgent</text><path d="M161,515.8516 L316,515.8516 L316,522.8516 L306,532.8516 L161,532.8516 L161,515.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1096.5703" style="stroke: #000000; stroke-width: 2.0;" width="1717.5" x="161" y="515.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="176" y="528.9185">Device running</text><polygon fill="#A80036" points="969,550.1172,979,554.1172,969,558.1172,973,554.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="975" y1="554.1172" y2="554.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="218.5" y="549.0513">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="241.5" y="549.0513">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1023" y1="583.25" y2="583.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1023" x2="1023" y1="583.25" y2="596.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="982" x2="1023" y1="596.25" y2="596.25"/><polygon fill="#A80036" points="992,592.25,982,596.25,992,600.25,988,596.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="988" y="578.1841">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="1010" y="578.1841">Generate CSR to get idenitity cert (DIdC)</text><polygon fill="#A80036" points="697,621.3828,687,625.3828,697,629.3828,693,625.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691" x2="980" y1="625.3828" y2="625.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="703" y="620.3169">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="725" y="620.3169">CSR for identity cert</text><polygon fill="#A80036" points="969,650.5156,979,654.5156,969,658.5156,973,654.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="686" x2="975" y1="654.5156" y2="654.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="693" y="649.4497">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="714" y="649.4497">Identity cert DIdC signed with CA2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1023" y1="683.6484" y2="683.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1023" x2="1023" y1="683.6484" y2="696.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="982" x2="1023" y1="696.6484" y2="696.6484"/><polygon fill="#A80036" points="992,692.6484,982,696.6484,992,700.6484,988,696.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="988" y="678.5825">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="1010" y="678.5825">Generate CSR to get device CA cert (DCAC)</text><polygon fill="#A80036" points="697,721.7813,687,725.7813,697,729.7813,693,725.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691" x2="980" y1="725.7813" y2="725.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="703" y="720.7153">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="725" y="720.7153">CSR for CA cert</text><polygon fill="#A80036" points="969,750.9141,979,754.9141,969,758.9141,973,754.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="686" x2="975" y1="754.9141" y2="754.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="693" y="749.8481">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="715" y="749.8481">Device CA Cert DCAC signed with CA1</text><polygon fill="#A80036" points="642.5,795.1797,632.5,799.1797,642.5,803.1797,638.5,799.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="636.5" x2="980" y1="799.1797" y2="799.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="648.5" y="786.5474">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="670.5" y="778.981">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="670.5" y="794.1138">with DIdC</text><polygon fill="#A80036" points="308,839.4453,298,843.4453,308,847.4453,304,843.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="302" x2="630.5" y1="843.4453" y2="843.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="830.813">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="336" y="823.2466">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="336" y="838.3794">thumbprint based auth</text><polygon fill="#A80036" points="619.5,868.5781,629.5,872.5781,619.5,876.5781,623.5,872.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="297" x2="625.5" y1="872.5781" y2="872.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="867.5122">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="326" y="867.5122">Device info</text><polygon fill="#A80036" points="969,912.8438,979,916.8438,969,920.8438,973,916.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="631.5" x2="975" y1="916.8438" y2="916.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="638.5" y="904.2114">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="661.5" y="896.645">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="661.5" y="911.7778">(IoTHub + deviceId)</text><polygon fill="#A80036" points="1245,941.9766,1255,945.9766,1245,949.9766,1249,945.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1251" y1="945.9766" y2="945.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="988" y="940.9106">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1010" y="940.9106">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1257" y="924.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1264" y="944.8389">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1305" x2="1347" y1="991.2734" y2="991.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1347" x2="1347" y1="991.2734" y2="1004.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1306" x2="1347" y1="1004.2734" y2="1004.2734"/><polygon fill="#A80036" points="1316,1000.2734,1306,1004.2734,1316,1008.2734,1312,1004.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1312" y="986.2075">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1334" y="986.2075">Process deployment</text><polygon fill="#A80036" points="992,1044.5391,982,1048.5391,992,1052.5391,988,1048.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="986" x2="1304" y1="1048.5391" y2="1048.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="998" y="1035.9067">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1019" y="1028.3403">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="1019" y="1043.4731">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="308,1088.8047,298,1092.8047,308,1096.8047,304,1092.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="302" x2="980" y1="1092.8047" y2="1092.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="1080.1724">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="336" y="1072.606">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="336" y="1087.7388">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1446,1117.9375,1456,1121.9375,1446,1125.9375,1450,1121.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1305" x2="1452" y1="1121.9375" y2="1121.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1312" y="1116.8716">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1334" y="1116.8716">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1458" y="1100.8047"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1465" y="1120.7998">EdgeHub</text><polygon fill="#A80036" points="1783.5,1163.2344,1793.5,1167.2344,1783.5,1171.2344,1787.5,1167.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1305" x2="1789.5" y1="1167.2344" y2="1167.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1312" y="1162.1685">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1334" y="1162.1685">Create and start</text><rect fill="#FEFECE" filter="url(#f2a2wicjmfabo)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1795.5" y="1146.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1802.5" y="1166.0967">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1805.5" y="1182.3936">Module</text><polygon fill="#A80036" points="992,1224.8281,982,1228.8281,992,1232.8281,988,1228.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="986" x2="1497" y1="1228.8281" y2="1228.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="998" y="1223.7622">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="1020" y="1223.7622">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1023" y1="1257.9609" y2="1257.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1023" x2="1023" y1="1257.9609" y2="1270.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="982" x2="1023" y1="1270.9609" y2="1270.9609"/><polygon fill="#A80036" points="992,1266.9609,982,1270.9609,992,1274.9609,988,1270.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="988" y="1252.895">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1010" y="1252.895">Generate server cert from DCAC</text><polygon fill="#A80036" points="1486,1296.0938,1496,1300.0938,1486,1304.0938,1490,1300.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="981" x2="1492" y1="1300.0938" y2="1300.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="988" y="1295.0278">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="1010" y="1295.0278">Server cert</text><polygon fill="#A80036" points="992,1325.2266,982,1329.2266,992,1333.2266,988,1329.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="986" x2="1831" y1="1329.2266" y2="1329.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="998" y="1324.1606">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1020" y="1324.1606">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1023" y1="1358.3594" y2="1358.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1023" x2="1023" y1="1358.3594" y2="1371.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="982" x2="1023" y1="1371.3594" y2="1371.3594"/><polygon fill="#A80036" points="992,1367.3594,982,1371.3594,992,1375.3594,988,1371.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="988" y="1353.2935">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="1009" y="1353.2935">Generate client cert from DCAC</text><polygon fill="#A80036" points="1820,1396.4922,1830,1400.4922,1820,1404.4922,1824,1400.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="981" x2="1826" y1="1400.4922" y2="1400.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="988" y="1395.4263">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1009" y="1395.4263">Module local identity</text><polygon fill="#A80036" points="1509,1425.625,1499,1429.625,1509,1433.625,1505,1429.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1503" x2="1831" y1="1429.625" y2="1429.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="1515" y="1424.5591">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1535" y="1424.5591">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1509,1454.7578,1499,1458.7578,1509,1462.7578,1505,1458.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1503" x2="1831" y1="1458.7578" y2="1458.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1515" y="1453.6919">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1536" y="1453.6919">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="992,1483.8906,982,1487.8906,992,1491.8906,988,1487.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="986" x2="1497" y1="1487.8906" y2="1487.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="998" y="1482.8247">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1019" y="1482.8247">Get IoTHub identity</text><polygon fill="#A80036" points="1486,1513.0234,1496,1517.0234,1486,1521.0234,1490,1517.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="981" x2="1492" y1="1517.0234" y2="1517.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="988" y="1511.9575">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="1009" y="1511.9575">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="992,1542.1563,982,1546.1563,992,1550.1563,988,1546.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="986" x2="1497" y1="1546.1563" y2="1546.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="998" y="1541.0903">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="1019" y="1541.0903">Sign token</text><polygon fill="#A80036" points="1486,1571.2891,1496,1575.2891,1486,1579.2891,1490,1575.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="981" x2="1492" y1="1575.2891" y2="1575.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="988" y="1570.2231">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1009" y="1570.2231">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="308,1600.4219,298,1604.4219,308,1608.4219,304,1604.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="302" x2="1497" y1="1604.4219" y2="1604.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="314" y="1599.356">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="335" y="1599.356">Connect using token and forward telemetry</text><!--MD5=[6d764361435edceb368c67fb0ead075b]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps
participant "EST" as est

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->est : Register CA signing Cert (CA1)\nfor signing certificates
oem->est : Register Identity CA Cert (CA2)\nfor signing identity certificates
note over oem: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->est : Register EST authentication cert ESTC\n(Used to authenticate against the EST server)
oem->dps : Create group enrollment with Identity CA Certificate (CA2) 
oem->device : Install DIdC on the device (file system or HSM) 
oem->device : Install ESTC on the device (file system or HSM)
end 

group Device setup and configuration
oem->ie : Configure device to sign certificates using EST server
oem->ie : Configure device for DPS provisioning
oem->ie : Configure EdgeAgent
end

group Device running
oem -> ie : Start IoT Edge runtime

ie -> ie : Generate CSR to get idenitity cert (DIdC)
ie -> est : CSR for identity cert
return Identity cert DIdC signed with CA2

ie -> ie : Generate CSR to get device CA cert (DCAC)
ie -> est : CSR for CA cert
return Device CA Cert DCAC signed with CA1

ie -> dps : Provision device\nwith DIdC
dps -> ih : Create device with\nthumbprint based auth
return Device info
dps - -> ie: Provisioning info\n(IoTHub + deviceId)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.08beta10(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>