<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1709px" preserveAspectRatio="none" style="width:1975px;height:1709px;" version="1.1" viewBox="0 0 1975 1709" width="1975px" zoomAndPan="magnify"><defs><filter height="300%" id="f1woukbn208e4h" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1694.7656" style="stroke: #A80036; stroke-width: 1.0;" width="985" x="963.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="1434" y="16.0605">Device</text><rect fill="#FFFFFF" filter="url(#f1woukbn208e4h)" height="245.1094" style="stroke: #000000; stroke-width: 2.0;" width="685" x="12" y="92.0469"/><rect fill="#FFFFFF" filter="url(#f1woukbn208e4h)" height="106.1719" style="stroke: #000000; stroke-width: 2.0;" width="906.5" x="145" y="351.1563"/><rect fill="#FFFFFF" filter="url(#f1woukbn208e4h)" height="1155.625" style="stroke: #000000; stroke-width: 2.0;" width="1458.5" x="506" y="471.3281"/><rect fill="#FFFFFF" filter="url(#f1woukbn208e4h)" height="739.875" style="stroke: #000000; stroke-width: 2.0;" width="1267.5" x="687" y="495.5625"/><rect fill="#FFFFFF" filter="url(#f1woukbn208e4h)" height="370.5156" style="stroke: #000000; stroke-width: 2.0;" width="1125.5" x="516" y="1249.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193" x2="193" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="193" x2="193" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193" x2="193" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="193" x2="193" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193" x2="193" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="193" x2="193" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193" x2="193" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560" x2="560" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="560" x2="560" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560" x2="560" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="560" x2="560" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560" x2="560" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="560" x2="560" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560" x2="560" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646" x2="646" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="646" x2="646" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646" x2="646" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="646" x2="646" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646" x2="646" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="646" x2="646" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646" x2="646" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="776" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="776" x2="776" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="776" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="776" x2="776" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="776" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="776" x2="776" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="776" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1004.5" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1004.5" x2="1004.5" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1004.5" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1004.5" x2="1004.5" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1004.5" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1004.5" x2="1004.5" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1004.5" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1280.5" y1="75.0469" y2="615.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1280.5" x2="1280.5" y1="615.7344" y2="656.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1280.5" y1="656.625" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1280.5" x2="1280.5" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1280.5" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1280.5" x2="1280.5" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1280.5" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1593.5" x2="1593.5" y1="760.7969" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1593.5" x2="1593.5" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1593.5" x2="1593.5" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1593.5" x2="1593.5" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1593.5" x2="1593.5" y1="1235.4375" y2="1643.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1908.5" x2="1908.5" y1="814.4063" y2="1153.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1908.5" x2="1908.5" y1="1153.6563" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1908.5" x2="1908.5" y1="1194.5469" y2="1194.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1908.5" x2="1908.5" y1="1194.5469" y2="1235.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1908.5" x2="1908.5" y1="1235.4375" y2="1643.9531"/><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="155" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="162" y="59.6289">Operator</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="155" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="162" y="1662.9414">Operator</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="526" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="533" y="59.6289">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="526" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="533" y="1662.9414">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="605" y="71.6289">Edge device</text><ellipse cx="646" cy="42.6406" fill="#FEFECE" filter="url(#f1woukbn208e4h)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="634" x2="658" y1="56.6406" y2="56.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="605" y="1655.9414">Edge device</text><ellipse cx="646" cy="1675.3594" fill="#FEFECE" filter="url(#f1woukbn208e4h)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="634" x2="658" y1="1689.3594" y2="1689.3594"/><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="155" x="697" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="748.5" y="43.2227">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="141" x="704" y="59.6289">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="155" x="697" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="748.5" y="1662.9414">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="141" x="704" y="1679.3477">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="967.5" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="974.5" y="43.2227">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="977" y="59.6289">runtime</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="967.5" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="974.5" y="1662.9414">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="977" y="1679.3477">runtime</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1236.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1243.5" y="59.6289">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1236.5" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1243.5" y="1662.9414">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1556.5" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1563.5" y="1662.9414">EdgeHub</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1873.5" y="1642.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1880.5" y="1662.9414">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1883" y="1679.3477">Module</text><path d="M12,92.0469 L137,92.0469 L137,99.0469 L127,109.0469 L12,109.0469 L12,92.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1094" style="stroke: #000000; stroke-width: 2.0;" width="685" x="12" y="92.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="27" y="105.1074">Initial Setup</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="235.5" y1="145.75" y2="145.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="235.5" x2="235.5" y1="145.75" y2="158.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194.5" x2="235.5" y1="158.75" y2="158.75"/><polygon fill="#A80036" points="204.5,154.75,194.5,158.75,204.5,162.75,200.5,158.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="132.959">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="211.5" y="125.3418">Generate device CA cert (DCAC) (self signed, or signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="211.5" y="140.5762">a topology CA Certificate (CA1) for gateway scenarios)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="235.5" y1="203.2188" y2="203.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="235.5" x2="235.5" y1="203.2188" y2="216.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194.5" x2="235.5" y1="216.2188" y2="216.2188"/><polygon fill="#A80036" points="204.5,212.2188,194.5,216.2188,204.5,220.2188,200.5,216.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="190.4277">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="211.5" y="182.8105">Generate device identity cert (DIdC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="211.5" y="198.0449">Identity CA Cert (CA2).</text><path d="M22,229.2188 L22,269.2188 L360,269.2188 L360,239.2188 L350,229.2188 L22,229.2188 " fill="#FBFB77" filter="url(#f1woukbn208e4h)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M350,229.2188 L350,239.2188 L360,239.2188 L350,229.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="28" y="246.2793">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="28" y="261.5137">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="548.5,295.9219,558.5,299.9219,548.5,303.9219,552.5,299.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="554.5" y1="299.9219" y2="299.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="294.748">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="211.5" y="294.748">Configure identity CA Certificate (CA2) for CA based auth</text><polygon fill="#A80036" points="634,325.1563,644,329.1563,634,333.1563,638,329.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="640" y1="329.1563" y2="329.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="323.9824">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="211.5" y="323.9824">Install DCAC and DIdC on the device (file system or HSM)</text><path d="M145,351.1563 L397,351.1563 L397,358.1563 L387,368.1563 L145,368.1563 L145,351.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.1719" style="stroke: #000000; stroke-width: 2.0;" width="906.5" x="145" y="351.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="160" y="364.2168">Device setup and configuration</text><polygon fill="#A80036" points="992.5,400.8594,1002.5,404.8594,992.5,408.8594,996.5,404.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="998.5" y1="404.8594" y2="404.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="392.0684">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="211.5" y="384.4512">Configure device CA (DCAC) in config.yaml (PKCS#11 URI or file path)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="211.5" y="399.6855">and provisioning in External Provisioning mode.</text><polygon fill="#A80036" points="992.5,445.3281,1002.5,449.3281,992.5,453.3281,996.5,449.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="193.5" x2="998.5" y1="449.3281" y2="449.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="200.5" y="436.5371">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="560" x="211.5" y="428.9199">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="211.5" y="444.1543">Configure EH Bridge to send telemetry upstream.</text><path d="M506,471.3281 L648,471.3281 L648,478.3281 L638,488.3281 L506,488.3281 L506,471.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1155.625" style="stroke: #000000; stroke-width: 2.0;" width="1458.5" x="506" y="471.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="521" y="484.3887">Device running</text><path d="M687,495.5625 L825,495.5625 L825,502.5625 L815,512.5625 L687,512.5625 L687,495.5625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="739.875" style="stroke: #000000; stroke-width: 2.0;" width="1267.5" x="687" y="495.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="702" y="508.623">Device Offline</text><polygon fill="#A80036" points="992.5,530.0313,1002.5,534.0313,992.5,538.0313,996.5,534.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776.5" x2="998.5" y1="534.0313" y2="534.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="783.5" y="528.8574">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="794.5" y="528.8574">Start IoT Edge runtime</text><polygon fill="#A80036" points="787.5,574.5,777.5,578.5,787.5,582.5,783.5,578.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="781.5" x2="1003.5" y1="578.5" y2="578.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="793.5" y="565.709">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="804.5" y="558.0918">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="804.5" y="573.3262">(external provisioning endpoint)</text><polygon fill="#FF0000" points="992.5,603.7344,1002.5,607.7344,992.5,611.7344,996.5,607.7344" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="776.5" x2="998.5" y1="607.7344" y2="607.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="783.5" y="602.5605">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="794.5" y="602.5605">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="232" x="935.25" y="639.9395">Provisioning attempts continue till success</text><polygon fill="#A80036" points="1268.5,673.8594,1278.5,677.8594,1268.5,681.8594,1272.5,677.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1274.5" y1="677.8594" y2="677.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="672.6855">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1029.5" y="672.6855">Create with local configuration and start</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1322.5" y1="707.0938" y2="707.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322.5" x2="1322.5" y1="707.0938" y2="720.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1281.5" x2="1322.5" y1="720.0938" y2="720.0938"/><polygon fill="#A80036" points="1291.5,716.0938,1281.5,720.0938,1291.5,724.0938,1287.5,720.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1287.5" y="701.9199">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1305.5" y="701.9199">Process deployment</text><polygon fill="#A80036" points="1544.5,745.3281,1554.5,749.3281,1544.5,753.3281,1548.5,749.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1550.5" y1="749.3281" y2="749.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1287.5" y="744.1543">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1305.5" y="744.1543">Create with local configuration and start</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1556.5" y="728.0938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1563.5" y="748.082">EdgeHub</text><polygon fill="#A80036" points="1861.5,790.7344,1871.5,794.7344,1861.5,798.7344,1865.5,794.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1867.5" y1="794.7344" y2="794.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1287.5" y="789.5605">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1305.5" y="789.5605">Create and start</text><rect fill="#FEFECE" filter="url(#f1woukbn208e4h)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1873.5" y="773.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1880.5" y="793.4883">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1883" y="809.8945">Module</text><polygon fill="#A80036" points="1015.5,852.5469,1005.5,856.5469,1015.5,860.5469,1011.5,856.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1009.5" x2="1593" y1="856.5469" y2="856.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1021.5" y="851.373">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="1039.5" y="851.373">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1046.5" y1="885.7813" y2="885.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1046.5" x2="1046.5" y1="885.7813" y2="898.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1005.5" x2="1046.5" y1="898.7813" y2="898.7813"/><polygon fill="#A80036" points="1015.5,894.7813,1005.5,898.7813,1015.5,902.7813,1011.5,898.7813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="880.6074">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1029.5" y="880.6074">Generate server cert from DCAC</text><polygon fill="#A80036" points="1582,924.0156,1592,928.0156,1582,932.0156,1586,928.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1588" y1="928.0156" y2="928.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="922.8418">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="1029.5" y="922.8418">Server cert</text><polygon fill="#A80036" points="1015.5,953.25,1005.5,957.25,1015.5,961.25,1011.5,957.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1009.5" x2="1908" y1="957.25" y2="957.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1021.5" y="952.0762">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="1039.5" y="952.0762">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1004.5" x2="1046.5" y1="986.4844" y2="986.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1046.5" x2="1046.5" y1="986.4844" y2="999.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1005.5" x2="1046.5" y1="999.4844" y2="999.4844"/><polygon fill="#A80036" points="1015.5,995.4844,1005.5,999.4844,1015.5,1003.4844,1011.5,999.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="981.3105">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="1029.5" y="981.3105">Generate client cert from DCAC</text><polygon fill="#A80036" points="1897,1024.7188,1907,1028.7188,1897,1032.7188,1901,1028.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1903" y1="1028.7188" y2="1028.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="1023.5449">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1029.5" y="1023.5449">Module local identity</text><polygon fill="#A80036" points="1605,1053.9531,1595,1057.9531,1605,1061.9531,1601,1057.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1599" x2="1908" y1="1057.9531" y2="1057.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1611" y="1052.7793">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1629" y="1052.7793">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1605,1083.1875,1595,1087.1875,1605,1091.1875,1601,1087.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1599" x2="1908" y1="1087.1875" y2="1087.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1611" y="1082.0137">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1629" y="1082.0137">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="1015.5,1112.4219,1005.5,1116.4219,1015.5,1120.4219,1011.5,1116.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1009.5" x2="1593" y1="1116.4219" y2="1116.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1021.5" y="1111.248">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="1039.5" y="1111.248">Get IoTHub identity</text><polygon fill="#FF0000" points="1582,1141.6563,1592,1145.6563,1582,1149.6563,1586,1145.6563" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1588" y1="1145.6563" y2="1145.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="1140.4824">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1029.5" y="1140.4824">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="308" x="897.25" y="1177.8613">EdgeHub continues to ask for IoTHub identity periodically</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="315" x="893.75" y="1218.752">App operation continues. EdgeHub stores telemetry locally</text><path d="M516,1249.4375 L685,1249.4375 L685,1256.4375 L675,1266.4375 L516,1266.4375 L516,1249.4375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="370.5156" style="stroke: #000000; stroke-width: 2.0;" width="1125.5" x="516" y="1249.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="531" y="1262.498">Device goes online</text><polygon fill="#A80036" points="787.5,1299.1406,777.5,1303.1406,787.5,1307.1406,783.5,1303.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="781.5" x2="1003.5" y1="1303.1406" y2="1303.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="793.5" y="1290.3496">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="811.5" y="1282.7324">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="811.5" y="1297.9668">(external provisioning endpoint)</text><polygon fill="#A80036" points="571.5,1343.6094,561.5,1347.6094,571.5,1351.6094,567.5,1347.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="565.5" x2="775.5" y1="1347.6094" y2="1347.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="577.5" y="1334.8184">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="595.5" y="1327.2012">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="595.5" y="1342.4355">CA based auth</text><polygon fill="#A80036" points="764.5,1372.8438,774.5,1376.8438,764.5,1380.8438,768.5,1376.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="560.5" x2="770.5" y1="1376.8438" y2="1376.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="567.5" y="1371.6699">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="585.5" y="1371.6699">Device info</text><polygon fill="#A80036" points="992.5,1417.3125,1002.5,1421.3125,992.5,1425.3125,996.5,1421.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="776.5" x2="998.5" y1="1421.3125" y2="1421.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783.5" y="1408.5215">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="801.5" y="1400.9043">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="801.5" y="1416.1387">(IoTHub + deviceId + DIdC)</text><polygon fill="#A80036" points="571.5,1461.7813,561.5,1465.7813,571.5,1469.7813,567.5,1465.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="565.5" x2="1003.5" y1="1465.7813" y2="1465.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="577.5" y="1452.9902">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="595.5" y="1445.373">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="595.5" y="1460.6074">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1015.5,1491.0156,1005.5,1495.0156,1015.5,1499.0156,1011.5,1495.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1009.5" x2="1593" y1="1495.0156" y2="1495.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1021.5" y="1489.8418">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="1039.5" y="1489.8418">Get IoTHub identity</text><polygon fill="#A80036" points="1582,1520.25,1592,1524.25,1582,1528.25,1586,1524.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1588" y1="1524.25" y2="1524.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="1519.0762">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="1029.5" y="1519.0762">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="1015.5,1549.4844,1005.5,1553.4844,1015.5,1557.4844,1011.5,1553.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1009.5" x2="1593" y1="1553.4844" y2="1553.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1021.5" y="1548.3105">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1039.5" y="1548.3105">Sign token</text><polygon fill="#A80036" points="1582,1578.7188,1592,1582.7188,1582,1586.7188,1586,1582.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1588" y1="1582.7188" y2="1582.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="1577.5449">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1029.5" y="1577.5449">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="571.5,1607.9531,561.5,1611.9531,571.5,1615.9531,567.5,1611.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="565.5" x2="1593" y1="1611.9531" y2="1611.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="577.5" y="1606.7793">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="595.5" y="1606.7793">Connect using token and forward telemetry</text><!--MD5=[251be084a0f013c96f57ac08ba5fc7bc]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "External\nProvisioning endpoint" as ae

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 
group Initial Setup 
oem->oem : Generate device CA cert (DCAC) (self signed, or signed by\na topology CA Certificate (CA1) for gateway scenarios)
oem->oem : Generate device identity cert (DIdC) signed by\nIdentity CA Cert (CA2).
note over oem: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->ih : Configure identity CA Certificate (CA2) for CA based auth 
oem->device : Install DCAC and DIdC on the device (file system or HSM) 
end 

group Device setup and configuration
oem->ie : Configure device CA (DCAC) in config.yaml (PKCS#11 URI or file path)\nand provisioning in External Provisioning mode. 
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end 

group Device running
group Device Offline

ae -> ie : Start IoT Edge runtime

ie -> ae : Provision device\n(external provisioning endpoint)
ae -[#red]-> ie : Failure
... Provisioning attempts continue till success ... 

ie -> ea ** : Create with local configuration and start
ea -> ea : Process deployment

ea -> eh ** : Create with local configuration and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh: Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm: Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie -[#red]-> eh : Failure
... EdgeHub continues to ask for IoTHub identity periodically ... 

... App operation continues. EdgeHub stores telemetry locally ... 
end 

group Device goes online
ie -> ae : Provision device\n(external provisioning endpoint)
ae -> ih : Create device with\nCA based auth
return Device info
ae - -> ie: Provisioning info\n(IoTHub + deviceId + DIdC)

ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
end
@enduml

PlantUML version 1.2020.06(Sun Apr 05 05:38:32 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.6+10-suse-3.1-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>