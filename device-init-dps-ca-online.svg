<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1571px" preserveAspectRatio="none" style="width:1635px;height:1571px;" version="1.1" viewBox="0 0 1635 1571" width="1635px" zoomAndPan="magnify"><defs><filter height="300%" id="fz2leajrcsa3z" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1556.0313" style="stroke: #A80036; stroke-width: 1.0;" width="843" x="775.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="1175" y="16.0605">Device</text><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="232.1094" style="stroke: #000000; stroke-width: 2.0;" width="673" x="13" y="92.0469"/><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="120.1719" style="stroke: #000000; stroke-width: 2.0;" width="729.5" x="134" y="338.1563"/><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="1015.8906" style="stroke: #000000; stroke-width: 2.0;" width="1490.5" x="134" y="472.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="182" x2="182" y1="75.0469" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="479" x2="479" y1="75.0469" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="565" x2="565" y1="75.0469" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="653" x2="653" y1="75.0469" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="816.5" x2="816.5" y1="75.0469" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1091.5" x2="1091.5" y1="714.1406" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1263.5" x2="1263.5" y1="890.7188" y2="1505.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1578.5" x2="1578.5" y1="944.3281" y2="1505.2188"/><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="144" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="151" y="59.6289">Operator</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="144" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="151" y="1524.207">Operator</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="445" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="452" y="59.6289">IoT Hub</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="445" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="452" y="1524.207">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="524" y="71.6289">Edge device</text><ellipse cx="565" cy="42.6406" fill="#FEFECE" filter="url(#fz2leajrcsa3z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="553" x2="577" y1="56.6406" y2="56.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="524" y="1517.207">Edge device</text><ellipse cx="565" cy="1536.625" fill="#FEFECE" filter="url(#fz2leajrcsa3z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="553" x2="577" y1="1550.625" y2="1550.625"/><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="631" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="638" y="59.6289">DPS</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="631" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="638" y="1524.207">DPS</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="779.5" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="786.5" y="43.2227">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="789" y="59.6289">runtime</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="779.5" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="786.5" y="1524.207">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="789" y="1540.6133">runtime</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1047.5" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1054.5" y="1524.207">EdgeAgent</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1226.5" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1233.5" y="1524.207">EdgeHub</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1543.5" y="1504.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1550.5" y="1524.207">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1553" y="1540.6133">Module</text><path d="M13,92.0469 L138,92.0469 L138,99.0469 L128,109.0469 L13,109.0469 L13,92.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="232.1094" style="stroke: #000000; stroke-width: 2.0;" width="673" x="13" y="92.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="28" y="105.1074">Initial Setup</text><polygon fill="#A80036" points="641.5,141.75,651.5,145.75,641.5,149.75,645.5,145.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="647.5" y1="145.75" y2="145.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="132.959">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="200.5" y="125.3418">Register signing CA Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="200.5" y="140.5762">for signing certificates</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="224.5" y1="190.2188" y2="190.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="224.5" x2="224.5" y1="190.2188" y2="203.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="183.5" x2="224.5" y1="203.2188" y2="203.2188"/><polygon fill="#A80036" points="193.5,199.2188,183.5,203.2188,193.5,207.2188,189.5,203.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="177.4277">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="200.5" y="169.8105">Generate device identity cert (DIdC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="200.5" y="185.0449">Identity CA Cert (CA2).</text><path d="M23,216.2188 L23,256.2188 L338,256.2188 L338,226.2188 L328,216.2188 L23,216.2188 " fill="#FBFB77" filter="url(#fz2leajrcsa3z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M328,216.2188 L328,226.2188 L338,226.2188 L328,216.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="29" y="233.2793">CA1 and CA2 can be same or different in this case</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="29" y="248.5137">because device does not have the CA cert</text><polygon fill="#A80036" points="641.5,282.9219,651.5,286.9219,641.5,290.9219,645.5,286.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="647.5" y1="286.9219" y2="286.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="281.748">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="200.5" y="281.748">Create group enrollment with Idenity CA Certificate (CA2)</text><polygon fill="#A80036" points="553,312.1563,563,316.1563,553,320.1563,557,316.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="559" y1="316.1563" y2="316.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="310.9824">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="200.5" y="310.9824">Install DIdC on the device (file system or HSM)</text><path d="M134,338.1563 L386,338.1563 L386,345.1563 L376,355.1563 L134,355.1563 L134,338.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="120.1719" style="stroke: #000000; stroke-width: 2.0;" width="729.5" x="134" y="338.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="149" y="351.2168">Device setup and configuration</text><polygon fill="#A80036" points="804.5,372.625,814.5,376.625,804.5,380.625,808.5,376.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="810.5" y1="376.625" y2="376.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="371.4512">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="200.5" y="371.4512">Configure device to sign certificates using DPS as a CA</text><polygon fill="#A80036" points="804.5,401.8594,814.5,405.8594,804.5,409.8594,808.5,405.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="810.5" y1="405.8594" y2="405.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="400.6855">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="200.5" y="400.6855">Configure device for DPS provisioning</text><polygon fill="#A80036" points="804.5,446.3281,814.5,450.3281,804.5,454.3281,808.5,450.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="810.5" y1="450.3281" y2="450.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="437.5371">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="560" x="200.5" y="429.9199">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="200.5" y="445.1543">Configure EH Bridge to send telemetry upstream.</text><path d="M134,472.3281 L276,472.3281 L276,479.3281 L266,489.3281 L134,489.3281 L134,472.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1015.8906" style="stroke: #000000; stroke-width: 2.0;" width="1490.5" x="134" y="472.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="149" y="485.3887">Device running</text><polygon fill="#A80036" points="804.5,506.7969,814.5,510.7969,804.5,514.7969,808.5,510.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="810.5" y1="510.7969" y2="510.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="189.5" y="505.623">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="200.5" y="505.623">Start IoT Edge runtime</text><polygon fill="#A80036" points="664.5,551.2656,654.5,555.2656,664.5,559.2656,660.5,555.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658.5" x2="815.5" y1="555.2656" y2="555.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="670.5" y="542.4746">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="681.5" y="534.8574">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="681.5" y="550.0918">with DIdC</text><polygon fill="#A80036" points="490.5,595.7344,480.5,599.7344,490.5,603.7344,486.5,599.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="484.5" x2="652.5" y1="599.7344" y2="599.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="496.5" y="586.9434">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="514.5" y="579.3262">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="514.5" y="594.5605">thumbprint based auth</text><polygon fill="#A80036" points="641.5,624.9688,651.5,628.9688,641.5,632.9688,645.5,628.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="647.5" y1="628.9688" y2="628.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="486.5" y="623.7949">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="504.5" y="623.7949">Device info</text><polygon fill="#A80036" points="804.5,669.4375,814.5,673.4375,804.5,677.4375,808.5,673.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="810.5" y1="673.4375" y2="673.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="660.5" y="660.6465">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="678.5" y="653.0293">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="678.5" y="668.2637">(IoTHub + deviceId)</text><polygon fill="#A80036" points="1035.5,698.6719,1045.5,702.6719,1035.5,706.6719,1039.5,702.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="816.5" x2="1041.5" y1="702.6719" y2="702.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="697.498">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="841.5" y="697.498">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="1047.5" y="681.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1054.5" y="701.4258">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1091.5" x2="1133.5" y1="748.0781" y2="748.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1133.5" x2="1133.5" y1="748.0781" y2="761.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1092.5" x2="1133.5" y1="761.0781" y2="761.0781"/><polygon fill="#A80036" points="1102.5,757.0781,1092.5,761.0781,1102.5,765.0781,1098.5,761.0781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1098.5" y="742.9043">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1116.5" y="742.9043">Process deployment</text><polygon fill="#A80036" points="827.5,801.5469,817.5,805.5469,827.5,809.5469,823.5,805.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="821.5" x2="1090.5" y1="805.5469" y2="805.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="833.5" y="792.7559">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="851.5" y="785.1387">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="851.5" y="800.373">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="490.5,846.0156,480.5,850.0156,490.5,854.0156,486.5,850.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="484.5" x2="815.5" y1="850.0156" y2="850.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="496.5" y="837.2246">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="514.5" y="829.6074">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="514.5" y="844.8418">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1214.5,875.25,1224.5,879.25,1214.5,883.25,1218.5,879.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1091.5" x2="1220.5" y1="879.25" y2="879.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1098.5" y="874.0762">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1116.5" y="874.0762">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1226.5" y="858.0156"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1233.5" y="878.0039">EdgeHub</text><polygon fill="#A80036" points="1531.5,920.6563,1541.5,924.6563,1531.5,928.6563,1535.5,924.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1091.5" x2="1537.5" y1="924.6563" y2="924.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1098.5" y="919.4824">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1116.5" y="919.4824">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1543.5" y="903.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1550.5" y="923.4102">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1553" y="939.8164">Module</text><polygon fill="#A80036" points="827.5,982.4688,817.5,986.4688,827.5,990.4688,823.5,986.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="821.5" x2="1263" y1="986.4688" y2="986.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="833.5" y="981.2949">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="851.5" y="981.2949">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="816.5" x2="858.5" y1="1015.7031" y2="1015.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="858.5" y1="1015.7031" y2="1028.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817.5" x2="858.5" y1="1028.7031" y2="1028.7031"/><polygon fill="#A80036" points="827.5,1024.7031,817.5,1028.7031,827.5,1032.7031,823.5,1028.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1010.5293">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="841.5" y="1010.5293">Generate CSR for server cert</text><polygon fill="#A80036" points="664.5,1053.9375,654.5,1057.9375,664.5,1061.9375,660.5,1057.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658.5" x2="815.5" y1="1057.9375" y2="1057.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="670.5" y="1052.7637">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="688.5" y="1052.7637">CSR for server cert</text><polygon fill="#A80036" points="804.5,1083.1719,814.5,1087.1719,804.5,1091.1719,808.5,1087.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="810.5" y1="1087.1719" y2="1087.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="660.5" y="1081.998">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="678.5" y="1081.998">Cert signed with CA1</text><polygon fill="#A80036" points="1252,1112.4063,1262,1116.4063,1252,1120.4063,1256,1116.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="816.5" x2="1258" y1="1116.4063" y2="1116.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1111.2324">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="841.5" y="1111.2324">Server cert</text><polygon fill="#A80036" points="827.5,1141.6406,817.5,1145.6406,827.5,1149.6406,823.5,1145.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="821.5" x2="1578" y1="1145.6406" y2="1145.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="833.5" y="1140.4668">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="851.5" y="1140.4668">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="816.5" x2="858.5" y1="1174.875" y2="1174.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="858.5" y1="1174.875" y2="1187.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817.5" x2="858.5" y1="1187.875" y2="1187.875"/><polygon fill="#A80036" points="827.5,1183.875,817.5,1187.875,827.5,1191.875,823.5,1187.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1169.7012">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="841.5" y="1169.7012">Generate CSR for client cert</text><polygon fill="#A80036" points="664.5,1213.1094,654.5,1217.1094,664.5,1221.1094,660.5,1217.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658.5" x2="815.5" y1="1217.1094" y2="1217.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="670.5" y="1211.9355">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="688.5" y="1211.9355">CSR for client cert</text><polygon fill="#A80036" points="804.5,1242.3438,814.5,1246.3438,804.5,1250.3438,808.5,1246.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="810.5" y1="1246.3438" y2="1246.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="660.5" y="1241.1699">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="678.5" y="1241.1699">Cert signed with CA1</text><polygon fill="#A80036" points="1567,1271.5781,1577,1275.5781,1567,1279.5781,1571,1275.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="816.5" x2="1573" y1="1275.5781" y2="1275.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1270.4043">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="841.5" y="1270.4043">Module local identity</text><polygon fill="#A80036" points="1275,1300.8125,1265,1304.8125,1275,1308.8125,1271,1304.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1269" x2="1578" y1="1304.8125" y2="1304.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1281" y="1299.6387">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1299" y="1299.6387">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1275,1330.0469,1265,1334.0469,1275,1338.0469,1271,1334.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1269" x2="1578" y1="1334.0469" y2="1334.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1281" y="1328.873">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1299" y="1328.873">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="827.5,1359.2813,817.5,1363.2813,827.5,1367.2813,823.5,1363.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="821.5" x2="1263" y1="1363.2813" y2="1363.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="833.5" y="1358.1074">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="851.5" y="1358.1074">Get IoTHub identity</text><polygon fill="#A80036" points="1252,1388.5156,1262,1392.5156,1252,1396.5156,1256,1392.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="816.5" x2="1258" y1="1392.5156" y2="1392.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1387.3418">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="841.5" y="1387.3418">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="827.5,1417.75,817.5,1421.75,827.5,1425.75,823.5,1421.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="821.5" x2="1263" y1="1421.75" y2="1421.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="833.5" y="1416.5762">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="851.5" y="1416.5762">Sign token</text><polygon fill="#A80036" points="1252,1446.9844,1262,1450.9844,1252,1454.9844,1256,1450.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="816.5" x2="1258" y1="1450.9844" y2="1450.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="823.5" y="1445.8105">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="841.5" y="1445.8105">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="490.5,1476.2188,480.5,1480.2188,490.5,1484.2188,486.5,1480.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="484.5" x2="1263" y1="1480.2188" y2="1480.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="496.5" y="1475.0449">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="514.5" y="1475.0449">Connect using token and forward telemetry</text><!--MD5=[4610ead5a64f960ede682f04a00456d8]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->dps : Register signing CA Cert (CA1)\nfor signing certificates
oem->oem : Generate device identity cert (DIdC) signed by\nIdentity CA Cert (CA2).
note over oem: CA1 and CA2 can be same or different in this case\nbecause device does not have the CA cert
oem->dps : Create group enrollment with Idenity CA Certificate (CA2) 
oem->device : Install DIdC on the device (file system or HSM) 
end

group Device setup and configuration
oem->ie : Configure device to sign certificates using DPS as a CA
oem->ie : Configure device for DPS provisioning
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end

group Device running
oem -> ie : Start IoT Edge runtime
ie -> dps : Provision device\nwith DIdC
dps -> ih : Create device with\nthumbprint based auth
ih - -> dps : Device info
dps - -> ie : Provisioning info\n(IoTHub + deviceId)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate CSR for server cert
ie -> dps : CSR for server cert 
dps - -> ie : Cert signed with CA1
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate CSR for client cert
ie -> dps : CSR for client cert
dps - -> ie : Cert signed with CA1
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie - -> eh : Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
ie - -> eh : Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.06(Sun Apr 05 05:38:32 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.6+10-suse-3.1-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>