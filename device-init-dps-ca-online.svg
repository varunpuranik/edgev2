<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1565px" preserveAspectRatio="none" style="width:1796px;height:1565px;" version="1.1" viewBox="0 0 1796 1565" width="1796px" zoomAndPan="magnify"><defs><filter height="300%" id="fz2leajrcsa3z" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1550.4844" style="stroke: #A80036; stroke-width: 1.0;" width="914.5" x="864.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="1297.25" y="16.0669">Device</text><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="231.1953" style="stroke: #000000; stroke-width: 2.0;" width="745" x="13" y="91.7266"/><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="808.5" x="148" y="336.9219"/><rect fill="#FFFFFF" filter="url(#fz2leajrcsa3z)" height="1012.3047" style="stroke: #000000; stroke-width: 2.0;" width="1637" x="148" y="470.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="198" x2="198" y1="74.7266" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="530.5" x2="530.5" y1="74.7266" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="620.5" x2="620.5" y1="74.7266" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="725" x2="725" y1="74.7266" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="907.5" x2="907.5" y1="74.7266" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1210.5" x2="1210.5" y1="711.4297" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1403.5" x2="1403.5" y1="887.3906" y2="1499.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1738" x2="1738" y1="940.8359" y2="1499.8906"/><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="158" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="165" y="59.4248">Operator</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="158" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="165" y="1518.8857">Operator</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="495.5" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="502.5" y="59.4248">IoT Hub</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="495.5" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="502.5" y="1518.8857">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="575.5" y="71.4248">Edge device</text><ellipse cx="621" cy="42.4297" fill="#FEFECE" filter="url(#fz2leajrcsa3z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="609" x2="633" y1="56.4297" y2="56.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="575.5" y="1511.8857">Edge device</text><ellipse cx="621" cy="1531.1875" fill="#FEFECE" filter="url(#fz2leajrcsa3z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="609" x2="633" y1="1545.1875" y2="1545.1875"/><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="703" y="39.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="710" y="59.4248">DPS</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="703" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="710" y="1518.8857">DPS</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="868.5" y="23.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="875.5" y="43.1279">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="879" y="59.4248">runtime</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="868.5" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="875.5" y="1518.8857">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="879" y="1535.1826">runtime</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1162.5" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1169.5" y="1518.8857">EdgeAgent</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1363.5" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1370.5" y="1518.8857">EdgeHub</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1702" y="1498.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1709" y="1518.8857">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1712" y="1535.1826">Module</text><path d="M13,91.7266 L149,91.7266 L149,98.7266 L139,108.7266 L13,108.7266 L13,91.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="231.1953" style="stroke: #000000; stroke-width: 2.0;" width="745" x="13" y="91.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="28" y="104.7935">Initial Setup</text><polygon fill="#A80036" points="713.5,141.125,723.5,145.125,713.5,149.125,717.5,145.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="719.5" y1="145.125" y2="145.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="132.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="218.5" y="124.9263">Register signing CA Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="218.5" y="140.0591">for signing certificates</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="240.5" y1="189.3906" y2="189.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240.5" x2="240.5" y1="189.3906" y2="202.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="199.5" x2="240.5" y1="202.3906" y2="202.3906"/><polygon fill="#A80036" points="209.5,198.3906,199.5,202.3906,209.5,206.3906,205.5,202.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="176.7583">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="218.5" y="169.1919">Generate device identity cert (DIdC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="218.5" y="184.3247">Identity CA Cert (CA2).</text><path d="M23,215.3906 L23,255.3906 L370,255.3906 L370,225.3906 L360,215.3906 L23,215.3906 " fill="#FBFB77" filter="url(#fz2leajrcsa3z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M360,215.3906 L360,225.3906 L370,225.3906 L360,215.3906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="29" y="232.4575">CA1 and CA2 can be same or different in this case</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="29" y="247.5903">because device does not have the CA cert</text><polygon fill="#A80036" points="713.5,281.7891,723.5,285.7891,713.5,289.7891,717.5,285.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="719.5" y1="285.7891" y2="285.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="205.5" y="280.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="217.5" y="280.7231">Create group enrollment with Idenity CA Certificate (CA2)</text><polygon fill="#A80036" points="609,310.9219,619,314.9219,609,318.9219,613,314.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="615" y1="314.9219" y2="314.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="309.856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="218.5" y="309.856">Install DIdC on the device (file system or HSM)</text><path d="M148,336.9219 L430,336.9219 L430,343.9219 L420,353.9219 L148,353.9219 L148,336.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="119.6641" style="stroke: #000000; stroke-width: 2.0;" width="808.5" x="148" y="336.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="163" y="349.9888">Device setup and configuration</text><polygon fill="#A80036" points="895.5,371.1875,905.5,375.1875,895.5,379.1875,899.5,375.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="901.5" y1="375.1875" y2="375.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="370.1216">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="218.5" y="370.1216">Configure device to sign certificates using DPS as a CA</text><polygon fill="#A80036" points="895.5,400.3203,905.5,404.3203,895.5,408.3203,899.5,404.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="901.5" y1="404.3203" y2="404.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="399.2544">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="218.5" y="399.2544">Configure device for DPS provisioning</text><polygon fill="#A80036" points="895.5,444.5859,905.5,448.5859,895.5,452.5859,899.5,448.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="901.5" y1="448.5859" y2="448.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="435.9536">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="611" x="218.5" y="428.3872">Configure deployment for device using local mode configuration for EA, EH and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="218.5" y="443.52">Configure EH Bridge to send telemetry upstream.</text><path d="M148,470.5859 L303,470.5859 L303,477.5859 L293,487.5859 L148,487.5859 L148,470.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1012.3047" style="stroke: #000000; stroke-width: 2.0;" width="1637" x="148" y="470.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="163" y="483.6528">Device running</text><polygon fill="#A80036" points="895.5,504.8516,905.5,508.8516,895.5,512.8516,899.5,508.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="198.5" x2="901.5" y1="508.8516" y2="508.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="205.5" y="503.7856">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="218.5" y="503.7856">Start IoT Edge runtime</text><polygon fill="#A80036" points="736.5,549.1172,726.5,553.1172,736.5,557.1172,732.5,553.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="730.5" x2="906.5" y1="553.1172" y2="553.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="742.5" y="540.4849">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="755.5" y="532.9185">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="755.5" y="548.0513">with DIdC</text><polygon fill="#A80036" points="541.5,593.3828,531.5,597.3828,541.5,601.3828,537.5,597.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="535.5" x2="724.5" y1="597.3828" y2="597.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="547.5" y="584.7505">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="570.5" y="577.1841">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="570.5" y="592.3169">thumbprint based auth</text><polygon fill="#A80036" points="713.5,622.5156,723.5,626.5156,713.5,630.5156,717.5,626.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="530.5" x2="719.5" y1="626.5156" y2="626.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="537.5" y="621.4497">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="559.5" y="621.4497">Device info</text><polygon fill="#A80036" points="895.5,666.7813,905.5,670.7813,895.5,674.7813,899.5,670.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="725.5" x2="901.5" y1="670.7813" y2="670.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="658.1489">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="754.5" y="650.5825">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="754.5" y="665.7153">(IoTHub + deviceId)</text><polygon fill="#A80036" points="1150.5,695.9141,1160.5,699.9141,1150.5,703.9141,1154.5,699.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="1156.5" y1="699.9141" y2="699.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="914.5" y="694.8481">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="935.5" y="694.8481">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1162.5" y="678.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1169.5" y="698.7764">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1210.5" x2="1252.5" y1="745.2109" y2="745.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1252.5" x2="1252.5" y1="745.2109" y2="758.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1211.5" x2="1252.5" y1="758.2109" y2="758.2109"/><polygon fill="#A80036" points="1221.5,754.2109,1211.5,758.2109,1221.5,762.2109,1217.5,758.2109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1217.5" y="740.145">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1239.5" y="740.145">Process deployment</text><polygon fill="#A80036" points="918.5,798.4766,908.5,802.4766,918.5,806.4766,914.5,802.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="1209.5" y1="802.4766" y2="802.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="924.5" y="789.8442">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="946.5" y="782.2778">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="946.5" y="797.4106">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="541.5,842.7422,531.5,846.7422,541.5,850.7422,537.5,846.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="535.5" x2="906.5" y1="846.7422" y2="846.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="547.5" y="834.1099">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="569.5" y="826.5435">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="569.5" y="841.6763">EdgeAgent and EdgeHub with SAS auth</text><polygon fill="#A80036" points="1351.5,871.875,1361.5,875.875,1351.5,879.875,1355.5,875.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1210.5" x2="1357.5" y1="875.875" y2="875.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1217.5" y="870.8091">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1239.5" y="870.8091">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1363.5" y="854.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1370.5" y="874.7373">EdgeHub</text><polygon fill="#A80036" points="1690,917.1719,1700,921.1719,1690,925.1719,1694,921.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1210.5" x2="1696" y1="921.1719" y2="921.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1217.5" y="916.106">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1239.5" y="916.106">Create and start</text><rect fill="#FEFECE" filter="url(#fz2leajrcsa3z)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="1702" y="900.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1709" y="920.0342">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1712" y="936.3311">Module</text><polygon fill="#A80036" points="918.5,978.7656,908.5,982.7656,918.5,986.7656,914.5,982.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="1402.5" y1="982.7656" y2="982.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="924.5" y="977.6997">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="946.5" y="977.6997">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="949.5" y1="1011.8984" y2="1011.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="949.5" x2="949.5" y1="1011.8984" y2="1024.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="908.5" x2="949.5" y1="1024.8984" y2="1024.8984"/><polygon fill="#A80036" points="918.5,1020.8984,908.5,1024.8984,918.5,1028.8984,914.5,1024.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="914.5" y="1006.8325">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="937.5" y="1006.8325">Generate CSR for server cert</text><polygon fill="#A80036" points="736.5,1050.0313,726.5,1054.0313,736.5,1058.0313,732.5,1054.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="730.5" x2="906.5" y1="1054.0313" y2="1054.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="742.5" y="1048.9653">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="764.5" y="1048.9653">CSR for server cert</text><polygon fill="#A80036" points="895.5,1079.1641,905.5,1083.1641,895.5,1087.1641,899.5,1083.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="725.5" x2="901.5" y1="1083.1641" y2="1083.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="1078.0981">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="754.5" y="1078.0981">Cert signed with CA1</text><polygon fill="#A80036" points="1391.5,1108.2969,1401.5,1112.2969,1391.5,1116.2969,1395.5,1112.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="907.5" x2="1397.5" y1="1112.2969" y2="1112.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="914.5" y="1107.231">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="935.5" y="1107.231">Server cert</text><polygon fill="#A80036" points="918.5,1137.4297,908.5,1141.4297,918.5,1145.4297,914.5,1141.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="1737.5" y1="1141.4297" y2="1141.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="924.5" y="1136.3638">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="946.5" y="1136.3638">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="949.5" y1="1170.5625" y2="1170.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="949.5" x2="949.5" y1="1170.5625" y2="1183.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="908.5" x2="949.5" y1="1183.5625" y2="1183.5625"/><polygon fill="#A80036" points="918.5,1179.5625,908.5,1183.5625,918.5,1187.5625,914.5,1183.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="914.5" y="1165.4966">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="936.5" y="1165.4966">Generate CSR for client cert</text><polygon fill="#A80036" points="736.5,1208.6953,726.5,1212.6953,736.5,1216.6953,732.5,1212.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="730.5" x2="906.5" y1="1212.6953" y2="1212.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="742.5" y="1207.6294">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="764.5" y="1207.6294">CSR for client cert</text><polygon fill="#A80036" points="895.5,1237.8281,905.5,1241.8281,895.5,1245.8281,899.5,1241.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="725.5" x2="901.5" y1="1241.8281" y2="1241.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="1236.7622">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="754.5" y="1236.7622">Cert signed with CA1</text><polygon fill="#A80036" points="1726.5,1266.9609,1736.5,1270.9609,1726.5,1274.9609,1730.5,1270.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="907.5" x2="1732.5" y1="1270.9609" y2="1270.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="914.5" y="1265.895">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="936.5" y="1265.895">Module local identity</text><polygon fill="#A80036" points="1414.5,1296.0938,1404.5,1300.0938,1414.5,1304.0938,1410.5,1300.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1408.5" x2="1737.5" y1="1300.0938" y2="1300.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1420.5" y="1295.0278">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1442.5" y="1295.0278">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1414.5,1325.2266,1404.5,1329.2266,1414.5,1333.2266,1410.5,1329.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1408.5" x2="1737.5" y1="1329.2266" y2="1329.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1420.5" y="1324.1606">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1442.5" y="1324.1606">Pub/sub to MQTT Broker using custom topics</text><polygon fill="#A80036" points="918.5,1354.3594,908.5,1358.3594,918.5,1362.3594,914.5,1358.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="1402.5" y1="1358.3594" y2="1358.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="924.5" y="1353.2935">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="945.5" y="1353.2935">Get IoTHub identity</text><polygon fill="#A80036" points="1391.5,1383.4922,1401.5,1387.4922,1391.5,1391.4922,1395.5,1387.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="907.5" x2="1397.5" y1="1387.4922" y2="1387.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="914.5" y="1382.4263">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="935.5" y="1382.4263">Identity info (IoTHub + deviceId + generation Id + credentials type)</text><polygon fill="#A80036" points="918.5,1412.625,908.5,1416.625,918.5,1420.625,914.5,1416.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="1402.5" y1="1416.625" y2="1416.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="924.5" y="1411.5591">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="944.5" y="1411.5591">Sign token</text><polygon fill="#A80036" points="1391.5,1441.7578,1401.5,1445.7578,1391.5,1449.7578,1395.5,1445.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="907.5" x2="1397.5" y1="1445.7578" y2="1445.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="914.5" y="1440.6919">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="935.5" y="1440.6919">Token signed with EdgeHub's SAS Key</text><polygon fill="#A80036" points="541.5,1470.8906,531.5,1474.8906,541.5,1478.8906,537.5,1474.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="535.5" x2="1402.5" y1="1474.8906" y2="1474.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="547.5" y="1469.8247">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="568.5" y="1469.8247">Connect using token and forward telemetry</text><!--MD5=[d4b271f2a56169beb8163d92db0b2b43]
@startuml
participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->dps : Register signing CA Cert (CA1)\nfor signing certificates
oem->oem : Generate device identity cert (DIdC) signed by\nIdentity CA Cert (CA2).
note over oem: CA1 and CA2 can be same or different in this case\nbecause device does not have the CA cert
oem->dps : Create group enrollment with Idenity CA Certificate (CA2) 
oem->device : Install DIdC on the device (file system or HSM) 
end

group Device setup and configuration
oem->ie : Configure device to sign certificates using DPS as a CA
oem->ie : Configure device for DPS provisioning
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end

group Device running
oem -> ie : Start IoT Edge runtime
ie -> dps : Provision device\nwith DIdC
dps -> ih : Create device with\nthumbprint based auth
ih - -> dps : Device info
dps - -> ie : Provisioning info\n(IoTHub + deviceId)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate CSR for server cert
ie -> dps : CSR for server cert 
dps - -> ie : Cert signed with CA1
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate CSR for client cert
ie -> dps : CSR for client cert
dps - -> ie : Cert signed with CA1
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie - -> eh : Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
ie - -> eh : Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.08beta10(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 14.0.1+7
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>